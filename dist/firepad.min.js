/*!
 * Firepad is an open-source, collaborative code and text editor. It was designed
 * to be embedded inside larger applications. Since it uses Firebase as a backend,
 * it requires no server-side code and can be added to any web app simply by
 * including a couple JavaScript files.
 *
 * Firepad 1.5.12
 * http://www.firepad.io/
 * License: MIT
 * Copyright: 2014 Firebase
 * With code from ot.js (Copyright 2012-2013 Tim Baumann)
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Firepad=e()}(this,(function(){"use strict";const t={makeEventEmitter:function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,n){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:n})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var n=this.eventListeners_[t]||[],r=0;r<n.length;r++)if(n[r].callback===e)return void n.splice(r,1)},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],n=0;n<e.length;n++)e[n].callback.apply(e[n].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_){for(var e=!1,n=0;n<this.allowedEvents_.length;n++)if(this.allowedEvents_[n]===t){e=!0;break}if(!e)throw new Error('Unknown event "'+t+'"')}}},elt:function(e,n,r){var i=document.createElement(e);if("string"==typeof n)t.setTextContent(i,n);else if(n)for(var o=0;o<n.length;++o)i.appendChild(n[o]);for(var s in r||{})i.setAttribute(s,r[s]);return i},setTextContent:function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},on:function(t,e,n,r){t.addEventListener?t.addEventListener(e,n,r||!1):t.attachEvent&&t.attachEvent("on"+e,n)},off:function(t,e,n,r){t.removeEventListener?t.removeEventListener(e,n,r||!1):t.detachEvent&&t.detachEvent("on"+e,n)},preventDefault:function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},stopPropagation:function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},stopEvent:function(e){t.preventDefault(e),t.stopPropagation(e)},stopEventAnd:function(e){return function(n){return e(n),t.stopEvent(n),!1}},trim:function(t){return t.replace(/^\s+/g,"").replace(/\s+$/g,"")},stringEndsWith:function(t,e){for(var n="string"==typeof e?[e]:e,r=0;r<n.length;r++){e=n[r];if(-1!==t.indexOf(e,t.length-e.length))return!0}return!1},assert:function(t,e){if(!t)throw new Error(e||"assertion error")},log:function(){if("undefined"!=typeof console&&void 0!==console.log){for(var t=["Firepad:"],e=0;e<arguments.length;e++)t.push(arguments[e]);console.log.apply(console,t)}}},e=function(){function e(e){this.type=e,this.chars=null,this.text=null,this.attributes=null,"insert"===e?(this.text=arguments[1],t.assert("string"==typeof this.text),this.attributes=arguments[2]||{},t.assert("object"==typeof this.attributes)):"delete"===e?(this.chars=arguments[1],t.assert("number"==typeof this.chars)):"retain"===e&&(this.chars=arguments[1],t.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},t.assert("object"==typeof this.attributes))}return e.prototype.isInsert=function(){return"insert"===this.type},e.prototype.isDelete=function(){return"delete"===this.type},e.prototype.isRetain=function(){return"retain"===this.type},e.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},e.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},e.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},e}(),n=function(){function n(){if(!this||this.constructor!==n)return new n;this.ops=[],this.baseLength=0,this.targetLength=0}function r(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function i(t){return t.ops[0].isRetain()?t.ops[0].chars:0}return n.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},n.prototype.retain=function(t,n){if("number"!=typeof t||t<0)throw new Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,n=n||{};var r=this.ops.length>0?this.ops[this.ops.length-1]:null;return r&&r.isRetain()&&r.attributesEqual(n)?r.chars+=t:this.ops.push(new e("retain",t,n)),this},n.prototype.insert=function(t,n){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;n=n||{},this.targetLength+=t.length;var r=this.ops.length>0?this.ops[this.ops.length-1]:null,i=this.ops.length>1?this.ops[this.ops.length-2]:null;return r&&r.isInsert()&&r.attributesEqual(n)?r.text+=t:r&&r.isDelete()?i&&i.isInsert()&&i.attributesEqual(n)?i.text+=t:(this.ops[this.ops.length-1]=new e("insert",t,n),this.ops.push(r)):this.ops.push(new e("insert",t,n)),this},n.prototype.delete=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||t<0)throw new Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var n=this.ops.length>0?this.ops[this.ops.length-1]:null;return n&&n.isDelete()?n.chars+=t:this.ops.push(new e("delete",t)),this},n.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},n.prototype.clone=function(){for(var t=new n,e=0;e<this.ops.length;e++)this.ops[e].isRetain()?t.retain(this.ops[e].chars,this.ops[e].attributes):this.ops[e].isInsert()?t.insert(this.ops[e].text,this.ops[e].attributes):t.delete(this.ops[e].chars);return t},n.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],n=0,r=this.length;n<r;n++)e[n]=t(this[n]);return e}).call(this.ops,(function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars})).join(", ")},n.prototype.toJSON=function(){for(var t=[],e=0;e<this.ops.length;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},n.fromJSON=function(e){for(var r=new n,i=0,o=e.length;i<o;i++){var s=e[i],a={};"object"==typeof s&&(a=s,s=e[++i]),"number"==typeof s?s>0?r.retain(s,a):r.delete(-s):(t.assert("string"==typeof s),r.insert(s,a))}return r},n.prototype.apply=function(e,n,r){if(n=n||[],r=r||[],e.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var i,o,s=[],a=0,h=0,c=this.ops,u=0,l=c.length;u<l;u++){var p=c[u];if(p.isRetain()){if(h+p.chars>e.length)throw new Error("Operation can't retain more characters than are left in the string.");for(s[a++]=e.slice(h,h+p.chars),i=0;i<p.chars;i++){var d=n[h+i]||{},f={};for(o in d)f[o]=d[o],t.assert(!1!==f[o]);for(o in p.attributes)!1===p.attributes[o]?delete f[o]:f[o]=p.attributes[o],t.assert(!1!==f[o]);r.push(f)}h+=p.chars}else if(p.isInsert())for(s[a++]=p.text,i=0;i<p.text.length;i++){var g={};for(o in p.attributes)g[o]=p.attributes[o],t.assert(!1!==g[o]);r.push(g)}else h+=p.chars}if(h!==e.length)throw new Error("The operation didn't operate on the whole string.");var m=s.join("");return t.assert(m.length===r.length),m},n.prototype.invert=function(t){for(var e=0,r=new n,i=this.ops,o=0,s=i.length;o<s;o++){var a=i[o];a.isRetain()?(r.retain(a.chars),e+=a.chars):a.isInsert()?r.delete(a.text.length):(r.insert(t.slice(e,e+a.chars)),e+=a.chars)}return r},n.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");function e(t,e,n){var r,i={};for(r in t)i[r]=t[r];for(r in e)n&&!1===e[r]?delete i[r]:i[r]=e[r];return i}for(var r,i=new n,o=this.clone().ops,s=t.clone().ops,a=0,h=0,c=o[a++],u=s[h++];void 0!==c||void 0!==u;)if(c&&c.isDelete())i.delete(c.chars),c=o[a++];else if(u&&u.isInsert())i.insert(u.text,u.attributes),u=s[h++];else{if(void 0===c)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===u)throw new Error("Cannot compose operations: first operation is too long.");if(c.isRetain()&&u.isRetain())r=e(c.attributes,u.attributes),c.chars>u.chars?(i.retain(u.chars,r),c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(i.retain(c.chars,r),c=o[a++],u=s[h++]):(i.retain(c.chars,r),u.chars-=c.chars,c=o[a++]);else if(c.isInsert()&&u.isDelete())c.text.length>u.chars?(c.text=c.text.slice(u.chars),u=s[h++]):c.text.length===u.chars?(c=o[a++],u=s[h++]):(u.chars-=c.text.length,c=o[a++]);else if(c.isInsert()&&u.isRetain())r=e(c.attributes,u.attributes,!0),c.text.length>u.chars?(i.insert(c.text.slice(0,u.chars),r),c.text=c.text.slice(u.chars),u=s[h++]):c.text.length===u.chars?(i.insert(c.text,r),c=o[a++],u=s[h++]):(i.insert(c.text,r),u.chars-=c.text.length,c=o[a++]);else{if(!c.isRetain()||!u.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(u));c.chars>u.chars?(i.delete(u.chars),c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(i.delete(u.chars),c=o[a++],u=s[h++]):(i.delete(c.chars),u.chars-=c.chars,c=o[a++])}}return i},n.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=i(this),n=i(t),o=r(this),s=r(t);return!(!o||!s)&&(o.isInsert()&&s.isInsert()?e+o.text.length===n:!(!o.isDelete()||!s.isDelete())&&(n+s.chars===e||e===n))},n.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=i(this),n=i(t),o=r(this),s=r(t);return!(!o||!s)&&(o.isInsert()&&s.isInsert()?e+o.text.length===n||e===n:!(!o.isDelete()||!s.isDelete())&&n+s.chars===e)},n.transformAttributes=function(e,n){var r,i={},o={},s={};for(r in e)s[r]=!0;for(r in n)s[r]=!0;for(r in s){var a=e[r],h=n[r];t.assert(null!=a||null!=h),null==a?o[r]=h:null==h?i[r]=a:a===h||(i[r]=a)}return[i,o]},n.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var r=new n,i=new n,o=t.clone().ops,s=e.clone().ops,a=0,h=0,c=o[a++],u=s[h++];void 0!==c||void 0!==u;)if(c&&c.isInsert())r.insert(c.text,c.attributes),i.retain(c.text.length),c=o[a++];else if(u&&u.isInsert())r.retain(u.text.length),i.insert(u.text,u.attributes),u=s[h++];else{if(void 0===c)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===u)throw new Error("Cannot transform operations: first operation is too long.");var l;if(c.isRetain()&&u.isRetain()){var p=n.transformAttributes(c.attributes,u.attributes);c.chars>u.chars?(l=u.chars,c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(l=u.chars,c=o[a++],u=s[h++]):(l=c.chars,u.chars-=c.chars,c=o[a++]),r.retain(l,p[0]),i.retain(l,p[1])}else if(c.isDelete()&&u.isDelete())c.chars>u.chars?(c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(c=o[a++],u=s[h++]):(u.chars-=c.chars,c=o[a++]);else if(c.isDelete()&&u.isRetain())c.chars>u.chars?(l=u.chars,c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(l=u.chars,c=o[a++],u=s[h++]):(l=c.chars,u.chars-=c.chars,c=o[a++]),r.delete(l);else{if(!c.isRetain()||!u.isDelete())throw new Error("The two operations aren't compatible");c.chars>u.chars?(l=u.chars,c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(l=c.chars,c=o[a++],u=s[h++]):(l=c.chars,u.chars-=c.chars,c=o[a++]),i.delete(l)}}return[r,i]},n.prototype.transform=function(t){return n.transform(this,t)},n}(),r=function(e){"undefined"==typeof firebase&&"function"==typeof require&&"function"!=typeof Firebase&&(firebase=require("firebase/app"),require("firebase/database"));function r(t,e,r){this.ref_=t,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new n,this.revision_=0,this.pendingReceivedRevisions_={};var i=this;if(e){this.setUserId(e),this.setColor(r);var o=t.root.child(".info/connected");this.firebaseOn_(o,"value",(function(t){!0===t.val()&&i.initializeUserData_()}),this),this.on("ready",(function(){i.monitorCursors_()}))}else this.userId_=t.push().key;setTimeout((function(){i.monitorHistory_()}),0)}function i(t,e){if(!t)throw new Error(e||"assertion error")}t.makeEventEmitter(r,["ready","cursor","operation","ack","retry"]),r.prototype.dispose=function(){var t=this;this.removeFirebaseCallbacks_(),this.handleInitialRevisions_=()=>{},this.ready_?(this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove()),this.ref_=null,this.document_=null,this.zombie_=!0):this.on("ready",(function(){t.dispose()}))},r.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(t),this.initializeUserData_()},r.prototype.isHistoryEmpty=function(){return i(this.ready_,"Not ready yet."),0===this.revision_},r.prototype.sendOperation=function(e,n){var r=this;if(this.ready_){i(this.document_.targetLength===e.baseLength,"sendOperation() called with invalid operation.");var o=s(this.revision_);this.sent_={id:o,op:e},function e(i,o){r.ref_.child("history").child(i).transaction((function(t){if(null===t)return o}),(function(s,a,h){if(s){if("disconnect"!==s.message)throw t.log("Transaction failure!",s),s;r.sent_&&r.sent_.id===i?setTimeout((function(){e(i,o)}),0):n&&n(s,!1)}else n&&n(null,a)}),!1)}(o,{a:r.userId_,o:e.toJSON(),t:firebase.database.ServerValue.TIMESTAMP})}else this.on("ready",(function(){r.trigger("retry")}))},r.prototype.sendCursor=function(t){this.userRef_.child("cursor").set(t),this.cursor_=t},r.prototype.setColor=function(t){this.userRef_.child("color").set(t),this.color_=t},r.prototype.getDocument=function(){return this.document_},r.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},r.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},r.prototype.monitorCursors_=function(){var t=this.ref_.child("users"),e=this;function n(t){var n=t.key,r=t.val();e.trigger("cursor",n,r.cursor,r.color)}this.firebaseOn_(t,"child_added",n),this.firebaseOn_(t,"child_changed",n),this.firebaseOn_(t,"child_removed",(function(t){var n=t.key;e.trigger("cursor",n,null)}))},r.prototype.monitorHistory_=function(){var t=this;this.ref_.child("checkpoint").once("value",(function(e){if(!t.zombie_){var n=e.child("id").val(),r=e.child("o").val(),s=e.child("a").val();null!=r&&null!=n&&null!==s?(t.pendingReceivedRevisions_[n]={o:r,a:s},t.checkpointRevision_=function(t){i(t.length>0&&t[0]===o[t.length+8]);for(var e=0,n=1;n<t.length;n++)e*=o.length,e+=o.indexOf(t[n]);return e}(n),t.monitorHistoryStartingAt_(t.checkpointRevision_+1)):(t.checkpointRevision_=0,t.monitorHistoryStartingAt_(t.checkpointRevision_))}}))},r.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,s(t)),n=this;setTimeout((function(){n.firebaseOn_(e,"child_added",(function(t){var e=t.key;n.pendingReceivedRevisions_[e]=t.val(),n.ready_&&n.handlePendingReceivedRevisions_()})),e.once("value",(function(){n.handleInitialRevisions_()}))}),0)},r.prototype.handleInitialRevisions_=function(){i(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var e=s(this.revision_),n=this.pendingReceivedRevisions_;null!=n[e];){var r=this.parseRevision_(n[e]);r?this.document_=this.document_.compose(r.operation):t.log("Invalid operation.",this.ref_.toString(),e,n[e]),delete n[e],this.revision_++,e=s(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var o=this;setTimeout((function(){o.trigger("ready")}),0)},r.prototype.handlePendingReceivedRevisions_=function(){for(var e=this.pendingReceivedRevisions_,n=s(this.revision_),r=!1;null!=e[n];){this.revision_++;var i=this.parseRevision_(e[n]);i?(this.document_=this.document_.compose(i.operation),this.sent_&&n===this.sent_.id?this.sent_.op.equals(i.operation)&&i.author===this.userId_?(this.revision_%100==0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(r=!0,this.trigger("operation",i.operation)):this.trigger("operation",i.operation)):t.log("Invalid operation.",this.ref_.toString(),n,e[n]),delete e[n],n=s(this.revision_)}r&&(this.sent_=null,this.trigger("retry"))},r.prototype.parseRevision_=function(t){if("object"!=typeof t)return null;if("string"!=typeof t.a||"object"!=typeof t.o)return null;var e=null;try{e=n.fromJSON(t.o)}catch(t){return null}return e.baseLength!==this.document_.targetLength?null:{author:t.a,operation:e}},r.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:s(this.revision_-1)})},r.prototype.firebaseOn_=function(t,e,n,r){return this.firebaseCallbacks_.push({ref:t,eventType:e,callback:n,context:r}),t.on(e,n,r),n},r.prototype.firebaseOff_=function(t,e,n,r){t.off(e,n,r);for(var i=0;i<this.firebaseCallbacks_.length;i++){var o=this.firebaseCallbacks_[i];if(o.ref===t&&o.eventType===e&&o.callback===n&&o.context===r){this.firebaseCallbacks_.splice(i,1);break}}},r.prototype.removeFirebaseCallbacks_=function(){for(var t=0;t<this.firebaseCallbacks_.length;t++){var e=this.firebaseCallbacks_[t];e.ref.off(e.eventType,e.callback,e.context)}this.firebaseCallbacks_=[]};var o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function s(t){if(0===t)return"A0";for(var e="";t>0;){var n=t%o.length;e=o[n]+e,t-=n,t/=o.length}return o[e.length+9]+e}return r}(),i="b",o="i",s="u",a="s",h="f",c="fs",u="c",l="bc",p="ent",d="l",f="li",g="la",m="lt",y={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""},v=function(){var t=p,e=t+"_";function n(t,e){if(!(this instanceof n))return new n(t,e);this.type=t,this.info=e||{}}return n.prototype.toAttributes=function(){var n={};for(var r in n[t]=this.type,this.info)n[e+r]=this.info[r];return n},n.fromAttributes=function(r){var i=r[t],o={};for(var s in r)0===s.indexOf(e)&&(o[s.substr(e.length)]=r[s]);return new n(i,o)},n}();let b=null;const _=()=>b||window.document,x=function(){function e(){this.entities_={};var e=["src","alt","width","height","style","class"];this.register("img",{render:function(e){t.assert(e.src,"image entity should have 'src'!");for(var n=["src","alt","width","height","style","class"],r="<img ",i=0;i<n.length;i++){var o=n[i];o in e&&(r+=" "+o+'="'+e[o]+'"')}return r+=">"},fromElement:function(t){for(var n={},r=0;r<e.length;r++){var i=e[r];t.hasAttribute(i)&&(n[i]=t.getAttribute(i))}return n}})}return e.prototype.register=function(e,n){t.assert(n.render,"Entity options should include a 'render' function!"),t.assert(n.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[e]=n},e.prototype.renderToElement=function(t,e){return this.tryRenderToElement_(t,"render",e)},e.prototype.exportToElement=function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-firepad-entity",t.type),e},e.prototype.updateElement=function(t,e){var n=t.type,r=t.info;this.entities_[n]&&void 0!==this.entities_[n].update&&this.entities_[n].update(r,e)},e.prototype.fromElement=function(t){var e=t.getAttribute("data-firepad-entity");if(e||(e=t.nodeName.toLowerCase()),e&&this.entities_[e]){var n=this.entities_[e].fromElement(t);return new v(e,n)}},e.prototype.tryRenderToElement_=function(e,n,r){var i=e.type,o=e.info;if(this.entities_[i]&&this.entities_[i][n]){var s=_(),a=this.entities_[i][n](o,r,s);if(a){if("string"==typeof a){var h=_().createElement("div");return h.innerHTML=a,h.childNodes[0]}if("object"==typeof a)return t.assert(void 0!==a.nodeType,"Error rendering "+i+" entity.  render() function must return an html string or a DOM element."),a}}},e.prototype.entitySupportsUpdate=function(t){return this.entities_[t]&&this.entities_[t].update},e}(),w=function(){function e(t){if(!(this instanceof e))return new e(t);this.attributes=t||{},this.attributes[d]=!0}return e.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},e.prototype.cloneWithNewAttribute_=function(t,n){var r={};for(var i in this.attributes)r[i]=this.attributes[i];return!1===n?delete r[t]:r[t]=n,new e(r)},e.prototype.indent=function(t){return this.cloneWithNewAttribute_(f,t)},e.prototype.align=function(t){return this.cloneWithNewAttribute_(g,t)},e.prototype.listItem=function(e){return t.assert(!1===e||"u"===e||"o"===e||"t"===e||"tc"===e),this.cloneWithNewAttribute_(m,e)},e.prototype.getIndent=function(){return this.attributes[f]||0},e.prototype.getAlign=function(){return this.attributes[g]||0},e.prototype.getListItem=function(){return this.attributes[m]||!1},e}(),C=function(){function t(e){if(!(this instanceof t))return new t(e);this.attributes=e||{}}return t.prototype.cloneWithNewAttribute_=function(e,n){var r={};for(var i in this.attributes)r[i]=this.attributes[i];return!1===n?delete r[e]:r[e]=n,new t(r)},t.prototype.bold=function(t){return this.cloneWithNewAttribute_(i,t)},t.prototype.italic=function(t){return this.cloneWithNewAttribute_(o,t)},t.prototype.underline=function(t){return this.cloneWithNewAttribute_(s,t)},t.prototype.strike=function(t){return this.cloneWithNewAttribute_(a,t)},t.prototype.font=function(t){return this.cloneWithNewAttribute_(h,t)},t.prototype.fontSize=function(t){return this.cloneWithNewAttribute_(c,t)},t.prototype.color=function(t){return this.cloneWithNewAttribute_(u,t)},t.prototype.backgroundColor=function(t){return this.cloneWithNewAttribute_(l,t)},t}(),k=function t(e,n){if(!(this instanceof t))return new t(e,n);this.text=e,this.formatting=n||C()},A=function t(e,n){if(!(this instanceof t))return new t(e,n);"[object Array]"!==Object.prototype.toString.call(e)&&(e=void 0===e?[]:[e]),this.textPieces=e,this.formatting=n||w()},E=function(){var e,{LIST_TYPE:n}=w;function r(t,e,r){this.listType=t||n.UNORDERED,this.lineFormatting=e||w(),this.textFormatting=r||C()}function i(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}r.prototype.withTextFormatting=function(t){return new r(this.listType,this.lineFormatting,t)},r.prototype.withLineFormatting=function(t){return new r(this.listType,t,this.textFormatting)},r.prototype.withListType=function(t){return new r(t,this.lineFormatting,this.textFormatting)},r.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new r(this.listType,t,this.textFormatting)},r.prototype.withAlign=function(t){var e=this.lineFormatting.align(t);return new r(this.listType,e,this.textFormatting)},i.prototype.newlineIfNonEmpty=function(t){this.cleanLine_(),this.currentLine.length>0&&this.newline(t)},i.prototype.newlineIfNonEmptyOrListItem=function(t){this.cleanLine_(),(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(t)},i.prototype.newline=function(t){this.cleanLine_();var e=t.lineFormatting;null!==this.currentLineListItemType&&(e=e.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(A(this.currentLine,e)),this.currentLine=[]},i.prototype.makeListItem=function(t){this.currentLineListItemType=t},i.prototype.cleanLine_=function(){if(this.currentLine.length>0){var t=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[t].text=this.currentLine[t].text.replace(/ +$/g,"");for(var e=0;e<this.currentLine.length;e++)this.currentLine[e].text=this.currentLine[e].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var o=o||{ELEMENT_NODE:1,TEXT_NODE:3};function s(r,i,s){if(r.nodeType===o.ELEMENT_NODE){var h=e.fromElement(r);if(h)return void s.currentLine.push(new k(y.ENTITY_SENTINEL_CHARACTER,new C(h.toAttributes())))}switch(r.nodeType){case o.TEXT_NODE:var c=r.nodeValue.replace(/[ \n\t]+/g," ");s.currentLine.push(k(c,i.textFormatting));break;case o.ELEMENT_NODE:switch(i=function(e,n){for(var r=e.textFormatting,i=e.lineFormatting,o=n.split(";"),s=0;s<o.length;s++){var a=o[s].split(":");if(2===a.length){var h=t.trim(a[0]).toLowerCase(),c=t.trim(a[1]).toLowerCase();switch(h){case"text-decoration":var u=c.indexOf("underline")>=0,l=c.indexOf("line-through")>=0;r=r.underline(u).strike(l);break;case"font-weight":var p="bold"===c||parseInt(c)>=600;r=r.bold(p);break;case"font-style":var d="italic"===c||"oblique"===c;r=r.italic(d);break;case"color":r=r.color(c);break;case"background-color":r=r.backgroundColor(c);break;case"text-align":i=i.align(c);break;case"font-size":var f=null,g=["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"];t.stringEndsWith(c,g)?f=c:parseInt(c)&&(f=parseInt(c)+"px"),f&&(r=r.fontSize(f));break;case"font-family":var m=t.trim(c.split(",")[0]);m=(m=m.replace(/['"]/g,"")).replace(/\w\S*/g,(function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})),r=r.font(m)}}}return e.withLineFormatting(i).withTextFormatting(r)}(i,r.getAttribute("style")||""),r.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":s.newlineIfNonEmpty(i),a(r,i,s),s.newlineIfNonEmpty(i);break;case"center":i=i.withAlign("center"),s.newlineIfNonEmpty(i),a(r,i.withAlign("center"),s),s.newlineIfNonEmpty(i);break;case"b":case"strong":a(r,i.withTextFormatting(i.textFormatting.bold(!0)),s);break;case"u":a(r,i.withTextFormatting(i.textFormatting.underline(!0)),s);break;case"i":case"em":a(r,i.withTextFormatting(i.textFormatting.italic(!0)),s);break;case"s":a(r,i.withTextFormatting(i.textFormatting.strike(!0)),s);break;case"font":var u=r.getAttribute("face"),l=r.getAttribute("color"),p=parseInt(r.getAttribute("size"));u&&(i=i.withTextFormatting(i.textFormatting.font(u))),l&&(i=i.withTextFormatting(i.textFormatting.color(l))),p&&(i=i.withTextFormatting(i.textFormatting.fontSize(p))),a(r,i,s);break;case"br":s.newline(i);break;case"ul":s.newlineIfNonEmptyOrListItem(i);var d="firepad-todo"===r.getAttribute("class")?n.TODO:n.UNORDERED;a(r,i.withListType(d).withIncreasedIndent(),s),s.newlineIfNonEmpty(i);break;case"ol":s.newlineIfNonEmptyOrListItem(i),a(r,i.withListType(n.ORDERED).withIncreasedIndent(),s),s.newlineIfNonEmpty(i);break;case"li":!function(t,e,r){r.newlineIfNonEmptyOrListItem(e);var i="firepad-checked"===t.getAttribute("class")?n.TODOCHECKED:e.listType;r.makeListItem(i);var o=r.currentLine;a(t,e,r),(o===r.currentLine||r.currentLine.length>0)&&r.newline(e)}(r,i,s);break;case"style":break;default:a(r,i,s)}}}function a(t,e,n){if(t.hasChildNodes())for(var r=0;r<t.childNodes.length;r++)s(t.childNodes[r],e,n)}return function(t,n){var o=_().createElement("div");o.innerHTML=t,e=n;var a=new i;return s(o,new r,a),a.lines}}(),M=function(){var{LIST_TYPE:n}=w;function r(t){return t===n.ORDERED?"<ol>":t===n.UNORDERED?"<ul>":'<ul class="firepad-todo">'}function y(t){return t===n.ORDERED?"</ol>":"</ul>"}function b(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")}return function(_,x){for(var w,C,k="",A=!0,E=[],M=!1,S=!0,L=!0,T=0,R=_.ops[T],I=!1;R;){t.assert(R.isInsert());var F=R.attributes;if(A){A=!1;var O=0,D=null,N="left";d in F&&(O=F[f]||0,D=F[m]||null,N=F[g]||"left"),D&&(O=O||1),M?(k+="</li>",M=!1):S||(L&&(k+="<br/>"),k+="</div>"),S=!1,t.assert(O>=0,"Indent must not be negative.");for(;E.length>O||O===E.length&&null!==D&&(w=D,C=E[E.length-1],!(w===C||w===n.TODO&&C===n.TODOCHECKED||w===n.TODOCHECKED&&C===n.TODO));)k+=y(E.pop());for(;E.length<O;){var P=D||n.UNORDERED;I=D==n.TODO||D==n.TODOCHECKED||I,k+=r(P),E.push(P)}var B="left"!==N?' style="text-align:'+N+'"':"";if(D){var H="";switch(D){case n.TODOCHECKED:H=' class="firepad-checked"';break;case n.TODO:H=' class="firepad-unchecked"'}k+="<li"+H+B+">",M=!0}else k+="<div"+B+">";L=!0}if(d in F)R=_.ops[++T];else if(p in F){for(var j=0;j<R.text.length;j++){var W=v.fromAttributes(F);k+=x.exportToElement(W).outerHTML}R=_.ops[++T]}else{var z="",U="";for(var q in F){var V,Y,J=F[q];q===i||q===o||q===s||q===a?(t.assert(!0===J),V=Y=q):q===c?(V='span style="font-size: '+J,V+="string"!=typeof J||-1===J.indexOf("px",J.length-2)?'px"':'"',Y="span"):q===h?(V='span style="font-family: '+J+'"',Y="span"):q===u?(V='span style="color: '+J+'"',Y="span"):q===l?(V='span style="background-color: '+J+'"',Y="span"):t.log(!1,"Encountered unknown attribute while rendering html: "+q),V&&(z+="<"+V+">"),Y&&(U="</"+Y+">"+U)}var K=R.text,$=K.indexOf("\n");$>=0?(A=!0,R=$<K.length-1?new e("insert",K.substr($+1),F):_.ops[++T],K=K.substr(0,$)):R=_.ops[++T],(K=K.replace(/  +/g,(function(t){return new Array(t.length+1).join(" ")})).replace(/^ /," ").replace(/ $/," ")).length>0&&(L=!1),k+=z+b(K)+U}}for(M?k+="</li>":S||(L&&(k+="&nbsp;"),k+="</div>");E.length>0;)k+=y(E.pop());return I&&(k='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n'+k),k}}(),S=function(t,e){var n=[];function r(e,r){e instanceof k&&(r=e.formatting.attributes,e=e.text),n.push({string:e,attributes:r}),t="\n"===e[e.length-1]}function i(e,n){t&&r(y.LINE_SENTINEL_CHARACTER,e.formatting.attributes);for(var i=0;i<e.textPieces.length;i++)r(e.textPieces[i]);n&&r("\n")}for(var o=0;o<e.length;o++)e[o]instanceof A?i(e[o],o<e.length-1):r(e[o]);return n},L=function(){function t(t,e){this.position=t,this.selectionEnd=e}return t.fromJSON=function(e){return new t(e.position,e.selectionEnd)},t.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},t.prototype.compose=function(t){return t},t.prototype.transform=function(e){function n(t){for(var n=t,r=e.ops,i=0,o=e.ops.length;i<o&&(r[i].isRetain()?t-=r[i].chars:r[i].isInsert()?n+=r[i].text.length:(n-=Math.min(t,r[i].chars),t-=r[i].chars),!(t<0));i++);return n}var r=n(this.position);return this.position===this.selectionEnd?new t(r,r):new t(r,n(this.selectionEnd))},t}(),T=function(){function t(){this.state=n}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){return t.sendOperation(e),new r(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.serverRetry=function(t){throw new Error("There is no pending operation.")};var n=new e;function r(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return t.AwaitingConfirm=r,r.prototype.applyClient=function(t,e){return new i(this.outstanding,e)},r.prototype.applyServer=function(t,e){var n=this.outstanding.transform(e);return t.applyOperation(n[1]),new r(n[0])},r.prototype.serverAck=function(t){return n},r.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},t.AwaitingWithBuffer=i,i.prototype.applyClient=function(t,e){var n=this.buffer.compose(e);return new i(this.outstanding,n)},i.prototype.applyServer=function(t,e){var n=this.outstanding.transform(e),r=this.buffer.transform(n[1]);return t.applyOperation(r[1]),new i(n[0],r[0])},i.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new r(e)},i.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new r(this.buffer)},t}(),R=function(){var t="normal",e="undoing",n="redoing";function r(e){this.maxItems=e||50,this.state=t,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function i(t,e){for(var n=[],r=e.constructor,i=t.length-1;i>=0;i--){var o=r.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||n.push(o[0]),e=o[1]}return n.reverse()}return r.prototype.add=function(t,r){if(this.state===e)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===n)this.undoStack.push(t),this.dontCompose=!0;else{var i=this.undoStack;!this.dontCompose&&r&&i.length>0?i.push(t.compose(i.pop())):(i.push(t),i.length>this.maxItems&&i.shift()),this.dontCompose=!1,this.redoStack=[]}},r.prototype.transform=function(t){this.undoStack=i(this.undoStack,t),this.redoStack=i(this.redoStack,t)},r.prototype.performUndo=function(n){if(this.state=e,0===this.undoStack.length)throw new Error("undo not possible");n(this.undoStack.pop()),this.state=t},r.prototype.performRedo=function(e){if(this.state=n,0===this.redoStack.length)throw new Error("redo not possible");e(this.redoStack.pop()),this.state=t},r.prototype.canUndo=function(){return 0!==this.undoStack.length},r.prototype.canRedo=function(){return 0!==this.redoStack.length},r.prototype.isUndoing=function(){return this.state===e},r.prototype.isRedoing=function(){return this.state===n},r}(),I=function(t){function e(t,e){this.wrapped=t,this.meta=e}function n(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function r(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return e.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},e.prototype.invert=function(){var t=this.meta;return new e(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},e.prototype.compose=function(t){return new e(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var r={};return n(t,r),n(e,r),r}return e}(this.meta,t.meta))},e.transform=function(t,n){var i=t.wrapped.transform(n.wrapped);return[new e(i[0],r(t.meta,n.wrapped)),new e(i[1],r(n.meta,t.wrapped))]},e.prototype.transform=function(t){return e.transform(this,t)},e}(),F=function(){function t(t,e){this.cursorBefore=t,this.cursorAfter=e}function e(t,e){this.id=t,this.editorAdapter=e}function n(t,e){T.call(this),this.serverAdapter=t,this.editorAdapter=e,this.undoManager=new R,this.clients={};var n=this;this.editorAdapter.registerCallbacks({change:function(t,e){n.onChange(t,e)},cursorActivity:function(){n.onCursorActivity()},blur:function(){n.onBlur()},focus:function(){n.onFocus()}}),this.editorAdapter.registerUndo((function(){n.undo()})),this.editorAdapter.registerRedo((function(){n.redo()})),this.serverAdapter.registerCallbacks({ack:function(){n.serverAck(),n.focused&&n.state instanceof T.Synchronized&&(n.updateCursor(),n.sendCursor(n.cursor)),n.emitStatus()},retry:function(){n.serverRetry()},operation:function(t){n.applyServer(t)},cursor:function(t,e,r){if(n.serverAdapter.userId_!==t&&n.state instanceof T.Synchronized){var i=n.getClientObject(t);e?(r&&i.setColor(r),i.updateCursor(L.fromJSON(e))):i.removeCursor()}}})}return t.prototype.invert=function(){return new t(this.cursorAfter,this.cursorBefore)},t.prototype.compose=function(e){return new t(this.cursorBefore,e.cursorAfter)},t.prototype.transform=function(e){return new t(this.cursorBefore?this.cursorBefore.transform(e):null,this.cursorAfter?this.cursorAfter.transform(e):null)},e.prototype.setColor=function(t){this.color=t},e.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id)},e.prototype.removeCursor=function(){this.mark&&this.mark.clear()},function(t,e){function n(){}n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}(n,T),n.prototype.getClientObject=function(t){var n=this.clients[t];return n||(this.clients[t]=new e(t,this.editorAdapter))},n.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},n.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo((function(e){t.applyUnredo(e)}))},n.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo((function(e){t.applyUnredo(e)}))},n.prototype.onChange=function(e,n){var r=this.cursor;this.updateCursor();var i,o=this.undoManager.undoStack.length>0&&n.shouldBeComposedWithInverted((i=this.undoManager.undoStack,i[i.length-1]).wrapped),s=new t(this.cursor,r);this.undoManager.add(new I(n,s),o),this.applyClient(e)},n.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},n.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),!this.focused||t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},n.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},n.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},n.prototype.sendCursor=function(t){this.state instanceof T.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},n.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t),this.emitStatus()},n.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new I(t,null))},n.prototype.emitStatus=function(){var t=this;setTimeout((function(){t.trigger("synced",t.state instanceof T.Synchronized)}),0)},n}();t.makeEventEmitter(F,["synced"]);const O=function(){function t(e){if(!(this instanceof t))return new t(e);var n,i;"string"==typeof e?(void 0===window.firebase&&"object"!=typeof n?(console.log("REQUIRING"),n=require("firebase/app"),require("firebase/database")):n=window.firebase,i=n.database().refFromURL(e)):i=e,this.entityManager_=new x,this.firebaseAdapter_=new r(i),this.ready_=!1,this.zombie_=!1}return t.prototype.getDocument=function(t){var e=this;if(e.ready_)return t(e.firebaseAdapter_.getDocument());e.firebaseAdapter_.on("ready",(function(){e.ready_=!0,t(e.firebaseAdapter_.getDocument())}))},t.prototype.getText=function(t){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");this.getDocument((function(e){var n=e.apply("");for(var r in y)n=n.replace(new RegExp(y[r],"g"),"");t(n)}))},t.prototype.setText=function(t,e){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");var r=n().insert(t);this.sendOperationWithRetry(r,e)},t.prototype.initializeFakeDom=function(t){if("object"==typeof _())t();else{const e=require("jsdom"),{JSDOM:n}=e,{window:r}=new n("<head></head><body></body>");if(_())return r.close(),t();(t=>{b=t})(r.document),t()}},t.prototype.getHtml=function(t){var e=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");e.initializeFakeDom((function(){e.getDocument((function(n){t(M(n,e.entityManager_))}))}))},t.prototype.setHtml=function(t,e){var r=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");r.initializeFakeDom((function(){for(var i=E(t,r.entityManager_),o=S(!0,i),s=new n,a=0;a<o.length;a++)s.insert(o[a].string,o[a].attributes);r.sendOperationWithRetry(s,e)}))},t.prototype.sendOperationWithRetry=function(t,e){var n=this;n.getDocument((function(r){var i=t.clone().delete(r.targetLength);n.firebaseAdapter_.sendOperation(i,(function(r,i){i?void 0!==e&&e(null,i):n.sendOperationWithRetry(t,e)}))}))},t.prototype.dispose=function(){this.zombie_=!0,this.firebaseAdapter_.dispose()},t}(),D=function(){function t(t){this.rtcm=t,this.cm=t.codeMirror,i(this,"onChange"),i(this,"onAttributesChange"),i(this,"onCursorActivity"),i(this,"onFocus"),i(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function e(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function r(t,e){if(!t)throw new Error(e||"assertion error")}function i(t,e){var n=t[e];t[e]=function(){n.apply(t,arguments)}}function o(t){for(var e in t)return!1;return!0}function s(t,e){if("string"!=typeof t)throw new TypeError("Expected a string");3===(t=t.replace(/^#/,"")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var n=parseInt(t,16),r=[n>>16,n>>8&255,255&n],i="rgb";return null!=e&&(i="rgba",r.push(e)),i+"("+r.join(",")+")"}return t.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},t.operationFromCodeMirrorChanges=function(t,r){for(var i=e(r),o=(new n).retain(i),s=(new n).retain(i),a=t.length-1;a>=0;a--){var h=t[a],c=h.start,u=i-c-h.text.length;o=(new n).retain(c).delete(h.removed.length).insert(h.text,h.attributes).retain(u).compose(o),s=s.compose((new n).retain(c).delete(h.text.length).insert(h.removed,h.removedAttributes).retain(u)),i+=h.removed.length-h.text.length}return[o,s]},t.operationFromAttributesChanges=function(t,i){for(var o=e(i),s=new n,a=new n,h=0,c=0;c<t.length;c++){var u=t[c],l=u.start-h;r(l>=0),s.retain(l),a.retain(l);var p=u.end-u.start;s.retain(p,u.attributes),a.retain(p,u.attributesInverse),h=u.start+p}return s.retain(o-h),a.retain(o-h),[s,a]},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.onChange=function(e,n){if("RTCMADAPTER"!==n[0].origin){var r=t.operationFromCodeMirrorChanges(n,this.cm);this.trigger("change",r[0],r[1])}},t.prototype.onAttributesChange=function(e,n){if("RTCMADAPTER"!==n[0].origin){var r=t.operationFromAttributesChanges(n,this.cm);this.trigger("change",r[0],r[1])}},t.prototype.onCursorActivity=function(){var t=this;setTimeout((function(){t.trigger("cursorActivity")}),1)},t.prototype.onFocus=function(){this.trigger("focus")},t.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},t.prototype.getValue=function(){return this.cm.getValue()},t.prototype.getCursor=function(){var t,e=this.cm,n=e.getCursor(),r=e.indexFromPos(n);if(e.somethingSelected()){var i=e.getCursor(!0),o=0===function(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}(n,i)?e.getCursor(!1):i;t=e.indexFromPos(o)}else t=r;return new L(r,t)},t.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))},t.prototype.addStyleRule=function(t){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet}if(!this.addedStyleRules[t])return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},t.prototype.setOtherCursor=function(t,e,n){var r=this.cm.posFromIndex(t.position);if("string"==typeof e&&e.match(/^#[a-fA-F0-9]{3,6}$/)){var i=this.rtcm.end();if("object"==typeof t&&"number"==typeof t.position&&"number"==typeof t.selectionEnd&&!(t.position<0||t.position>i||t.selectionEnd<0||t.selectionEnd>i)){if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(r),a=document.createElement("span");return a.className="other-client",a.style.borderLeftWidth="2px",a.style.borderLeftStyle="solid",a.style.borderLeftColor=e,a.style.marginLeft=a.style.marginRight="-1px",a.style.height=.9*(o.bottom-o.top)+"px",a.setAttribute("data-clientid",n),a.style.zIndex=0,this.cm.setBookmark(r,{widget:a,insertLeft:!0})}var h,c,u="selection-"+e.replace("#",""),l="."+u+" { background: "+s(e)+";\n background: "+s(e,.4)+";}";return this.addStyleRule(l),t.selectionEnd>t.position?(h=r,c=this.cm.posFromIndex(t.selectionEnd)):(h=this.cm.posFromIndex(t.selectionEnd),c=r),this.cm.markText(h,c,{className:u})}}},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),n=this.callbacks&&this.callbacks[t];n&&n.apply(this,e)},t.prototype.applyOperation=function(t){t.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,n=0,r=0,i=e.length;r<i;r++){var s=e[r];s.isRetain()?(o(s.attributes)||this.rtcm.updateTextAttributes(n,n+s.chars,(function(t){for(var e in s.attributes)!1===s.attributes[e]?delete t[e]:t[e]=s.attributes[e]}),"RTCMADAPTER",!0),n+=s.chars):s.isInsert()?(this.rtcm.insertText(n,s.text,s.attributes,"RTCMADAPTER"),n+=s.text.length):s.isDelete()&&this.rtcm.removeText(n,n+s.chars,"RTCMADAPTER")}t.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},t.prototype.registerUndo=function(t){this.cm.undo=t},t.prototype.registerRedo=function(t){this.cm.redo=t},t.prototype.invertOperation=function(t){for(var e,r,i=0,s=this.rtcm.codeMirror,a=new n,h=0;h<t.wrapped.ops.length;h++){var c=t.wrapped.ops[h];if(c.isRetain())if(o(c.attributes))a.retain(c.chars),i+=c.chars;else for(e=this.rtcm.getAttributeSpans(i,i+c.chars),r=0;r<e.length;r++){var u={};for(var l in c.attributes){var p=c.attributes[l],d=e[r].attributes[l];!1===p?d&&(u[l]=d):p!==d&&(u[l]=d||!1)}a.retain(e[r].length,u),i+=e[r].length}else if(c.isInsert())a.delete(c.text.length);else if(c.isDelete()){var f=s.getRange(s.posFromIndex(i),s.posFromIndex(i+c.chars));e=this.rtcm.getAttributeSpans(i,i+c.chars);var g=0;for(r=0;r<e.length;r++)a.insert(f.substr(g,e[r].length),e[r].attributes),g+=e[r].length;i+=c.chars}}return new I(a,t.meta.invert())},t}(),N=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}(),P=function(){function t(t,e){if(!t)throw new Error("AnnotationList assertion failed"+(e?": "+e:""))}function e(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function n(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}e.prototype.getAttachedObject=function(){return this.attachedObject_},n.prototype.attachObject=function(t){this.node_.attachedObject=t};var r={equals:function(){return!1}};function i(t){this.head_=new o(0,r),this.changeHandler_=t}function o(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}return i.prototype.insertAnnotatedSpan=function(e,n){this.wrapOperation_(new N(e.pos,0),(function(i,s){t(!s||null===s.next);var a=new o(e.length,n);if(s){t(e.pos>i&&e.pos<i+s.length);var h=new o(0,r);return h.next=new o(e.pos-i,s.annotation),h.next.next=a,a.next=new o(i+s.length-e.pos,s.annotation),h.next}return a}))},i.prototype.removeSpan=function(e){0!==e.length&&this.wrapOperation_(e,(function(n,i){t(null!==i);var s=new o(0,r),a=s;for(e.pos>n&&(a.next=new o(e.pos-n,i.annotation),a=a.next);e.end()>n+i.length;)n+=i.length,i=i.next;var h=n+i.length-e.end();return h>0&&(a.next=new o(h,i.annotation)),s.next}))},i.prototype.updateSpan=function(e,n){0!==e.length&&this.wrapOperation_(e,(function(i,s){t(null!==s);var a=new o(0,r),h=a,c=i,u=e.pos-c;for(t(u<s.length),u>0&&(h.next=new o(u,s.annotation),c+=(h=h.next).length);null!==s&&e.end()>=i+s.length;){var l=i+s.length-c;h.next=new o(l,n(s.annotation,l)),h=h.next,i+=s.length,s=s.next,c=i}var p=e.end()-c;return p>0&&(t(p<s.length),h.next=new o(p,n(s.annotation,p)),c+=(h=h.next).length,h.next=new o(i+s.length-c,s.annotation)),a.next}))},i.prototype.wrapOperation_=function(t,r){if(t.pos<0)throw new Error("Span start cannot be negative.");var i,s=[],a=[],h=this.getAffectedNodes_(t);null!==h.start?(i=h.end.next,h.end.next=null):i=h.succ;var c=r(h.startPos,h.start),u=!1,l=!1;if(c){var p;for(this.mergeNodesWithSameAnnotations_(c),h.pred&&h.pred.annotation.equals(c.annotation)?(u=!0,c.length+=h.pred.length,h.beforePred.next=c,p=h.predPos):(h.beforeStart.next=c,p=h.startPos);c.next;)a.push(new n(p,c)),p+=c.length,c=c.next;h.succ&&h.succ.annotation.equals(c.annotation)?(c.length+=h.succ.length,l=!0,c.next=h.succ.next):c.next=i,a.push(new n(p,c))}else h.pred&&h.succ&&h.pred.annotation.equals(h.succ.annotation)?(u=!0,l=!0,c=new o(h.pred.length+h.succ.length,h.pred.annotation),h.beforePred.next=c,c.next=h.succ.next,a.push(new n(h.startPos-h.pred.length,c))):h.beforeStart.next=i;u&&s.push(new e(h.predPos,h.pred));for(var d=h.startPos,f=h.start;null!==f;)s.push(new e(d,f)),d+=f.length,f=f.next;l&&s.push(new e(d,h.succ)),this.changeHandler_(s,a)},i.prototype.getAffectedNodes_=function(t){for(var e={},n=null,r=this.head_,i=r.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,n=r,r=i,i=i.next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=r,o===t.pos&&o>0?(e.pred=r,e.predPos=o-r.length,e.beforePred=n):e.pred=null;null!==i&&t.end()>o;)o+=i.length,r=i,i=i.next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=r,e.succ=o===t.end()?i:null,e},i.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,n=t;n;)e&&e.annotation.equals(n.annotation)?(e.length+=n.length,e.next=n.next):e=n,n=n.next},i.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},i.prototype.getAnnotatedSpansForPos=function(t){for(var n=0,r=this.head_.next,i=null;null!==r&&n+r.length<=t;)n+=r.length,i=r,r=r.next;if(null===r&&n!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var o=[];return n===t&&i&&o.push(new e(n-i.length,i)),r&&o.push(new e(n,r)),o},i.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var e=[],n=this.getAffectedNodes_(t),r=n.startPos,i=n.start;null!==i&&r<t.end();){var o=Math.max(r,t.pos),s=Math.min(r+i.length,t.end()),a=new N(o,s-o);a.annotation=i.annotation,e.push(a),r+=i.length,i=i.next}return e},i.prototype.count=function(){for(var e=0,n=this.head_.next,r=null;null!==n;)r&&t(!r.annotation.equals(n.annotation)),r=n,n=n.next,e++;return e},o.prototype.clone=function(){var t=new o(this.spanLength,this.annotation);return t.next=this.next,t},i}(),B=function(){var e={c:"color",bc:"background-color",fs:"font-size",li:function(t){return"padding-left: "+40*t+"px"}},n={};function r(t,e,n){this.codeMirror=t,this.options_=n||{},this.entityManager_=e,this.currentAttributes_=null;var r=this;this.annotationList_=new P((function(t,e){r.onAnnotationsChanged_(t,e)})),this.initAnnotationList_(),u(this,"onCodeMirrorBeforeChange_"),u(this,"onCodeMirrorChange_"),u(this,"onCursorActivity_"),parseInt(CodeMirror.version)>=4?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[]}t.makeEventEmitter(r,["change","attributesChange","newLine"]);var i=y.LINE_SENTINEL_CHARACTER,o=y.ENTITY_SENTINEL_CHARACTER;function s(t,e){return function(t,e){return t.line-e.line||t.ch-e.ch}(t,e)<=0}function a(t){if(0===t.length)return 0;for(var e=0,n=0;n<t.length;n++)e+=t[n].length;return e+t.length-1}function h(t){this.attributes=t||{}}function u(t,e){var n=t[e];t[e]=function(){n.apply(t,arguments)}}return r.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},r.prototype.toggleAttribute=function(t,e){var n=e||!0;if(this.emptySelection_()){var r=this.getCurrentAttributes_();r[t]===n?delete r[t]:r[t]=n,this.currentAttributes_=r}else{var i=this.getCurrentAttributes_()[t]!==n&&n;this.setAttribute(t,i)}},r.prototype.setAttribute=function(t,e){var n=this.codeMirror;if(this.emptySelection_()){var r=this.getCurrentAttributes_();!1===e?delete r[t]:r[t]=e,this.currentAttributes_=r}else this.updateTextAttributes(n.indexFromPos(n.getCursor("start")),n.indexFromPos(n.getCursor("end")),(function(n){!1===e?delete n[t]:n[t]=e})),this.updateCurrentAttributes_()},r.prototype.updateTextAttributes=function(t,e,n,r,i){var o=[],s=t,a=this;this.annotationList_.updateSpan(new N(t,e-t),(function(t,e){var c={};for(var u in t.attributes)c[u]=t.attributes[u];c[d]&&!i||n(c);var l={},p={};return a.computeChangedAttributes_(t.attributes,c,l,p),function(t){for(var e in t)return!1;return!0}(l)||o.push({start:s,end:s+e,attributes:l,attributesInverse:p,origin:r}),s+=e,new h(c)})),o.length>0&&this.trigger("attributesChange",this,o)},r.prototype.computeChangedAttributes_=function(t,e,n,r){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(n[i]=e[i],r[i]=t[i]):(n[i]=e[i],r[i]=!1):(n[i]=!1,r[i]=t[i])},r.prototype.toggleLineAttribute=function(t,e){var n,r=this.getCurrentLineAttributes_();n=(!(t in r)||r[t]!==e)&&e,this.setLineAttribute(t,n)},r.prototype.setLineAttribute=function(t,e){this.updateLineAttributesForSelection((function(n){!1===e?delete n[t]:n[t]=e}))},r.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,n=e.getCursor("start"),r=e.getCursor("end"),i=n.line,o=r.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,r.ch));o>i&&a&&o--,this.updateLineAttributes(i,o,t)},r.prototype.updateLineAttributes=function(t,e,n){for(var r=t;r<=e;r++){var o=this.codeMirror.getLine(r),s=this.codeMirror.indexFromPos({line:r,ch:0});if(o[0]!==i){var a={};a[d]=!0,n(a),this.insertText(s,i,a)}else this.updateTextAttributes(s,s+1,n,null,!0)}},r.prototype.replaceText=function(t,e,n,r,i){this.changeId_++;var o="cmrt-"+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:r};var s=this.codeMirror,a=s.posFromIndex(t),h="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(n,a,h,o)},r.prototype.insertText=function(t,e,n,r){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"==r&&!i.somethingSelected()&&t==i.indexFromPos(o);this.replaceText(t,null,e,n,r),s&&i.setCursor(o)},r.prototype.removeText=function(t,e,n){var r=this.codeMirror;r.replaceRange("",r.posFromIndex(t),r.posFromIndex(e),n)},r.prototype.insertEntityAtCursor=function(t,e,n){var r=this.codeMirror,i=r.indexFromPos(r.getCursor("head"));this.insertEntityAt(i,t,e,n)},r.prototype.insertEntityAt=function(t,e,n,r){this.codeMirror,this.insertEntity_(t,new v(e,n),r)},r.prototype.insertEntity_=function(t,e,n){this.replaceText(t,null,o,e.toAttributes(),n)},r.prototype.getAttributeSpans=function(t,e){for(var n=[],r=this.annotationList_.getAnnotatedSpansForSpan(new N(t,e-t)),i=0;i<r.length;i++)n.push({length:r[i].length,attributes:r[i].annotation.attributes});return n},r.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},r.prototype.getRange=function(t,e){var n=this.codeMirror.posFromIndex(t),r=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(n,r)},r.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new N(0,t),new h)},r.prototype.onAnnotationsChanged_=function(t,e){var n,r={};this.tryToUpdateEntitiesInPlace(t,e);for(var i=0;i<t.length;i++){var o=t[i].annotation.attributes;d in o&&(r[this.codeMirror.posFromIndex(t[i].pos).line]=!0),(n=t[i].getAttachedObject())&&n.clear()}for(i=0;i<e.length;i++){var s=e[i].annotation,a=d in s.attributes,h=p in s.attributes,c=this.codeMirror.posFromIndex(e[i].pos);if(a)r[c.line]=!0;else if(h)this.markEntity_(e[i]);else{var u=this.getClassNameForAttributes_(s.attributes);if(""!==u){var l=this.codeMirror.posFromIndex(e[i].pos+e[i].length);n=this.codeMirror.markText(c,l,{className:u}),e[i].attachObject(n)}}}for(var f in r)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(f))),this.queueLineMarking_()},r.prototype.tryToUpdateEntitiesInPlace=function(t,e){for(var n=t.length;n--;)for(var r=t[n],i=e.length;i--;){var o=e[i];if(r.pos==o.pos&&r.length==o.length&&r.annotation.attributes.ent&&r.annotation.attributes.ent==o.annotation.attributes.ent){var s=o.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(s)){t.splice(n,1),e.splice(i,1);var a=r.getAttachedObject();a.update(o.annotation.attributes),o.attachObject(a)}}}},r.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var t=this;this.lineMarkTimeout_=setTimeout((function(){t.lineMarkTimeout_=null;for(var e=[],n=0;n<t.dirtyLines_.length;n++){var r=t.codeMirror.getLineNumber(t.dirtyLines_[n]);e.push(Number(r))}t.dirtyLines_=[],e.sort((function(t,e){return t-e}));var i=-1;for(n=0;n<e.length;n++){var o=e[n];o>i&&(i=t.markLineSentinelCharactersForChangedLines_(o,o))}}),0)}},r.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=t:n.appendChild(document.createTextNode(t)),e.appendChild(n)},r.prototype.getClassNameForAttributes_=function(r){var i="";for(var o in r){var s=r[o];if(o===d)t.assert(!0===s,"LINE_SENTINEL attribute should be true if it exists.");else{var a=(this.options_.cssPrefix||"cmrt-")+o;if(!0!==s){o===c&&"string"!=typeof s&&(s+="px");var h=s.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(a+="-"+h,e[o]&&(n[o]||(n[o]={}),!n[o][h])){n[o][h]=!0;var u=e[o],l="function"==typeof u?u(s):u+": "+s,p=o==f?"pre."+a:"."+a;if(this.addStyleWithCSS_(p+" { "+l+" }"),o===f){p="pre.CodeMirror-line."+a;this.addStyleWithCSS_(p+" { "+l+" }")}}}i=i+" "+a}}return i},r.prototype.markEntity_=function(t){for(var e=t.annotation.attributes,n=v.fromAttributes(e),r=this.codeMirror,i=this,o=[],s=0;s<t.length;s++){var a=r.posFromIndex(t.pos+s),h=r.posFromIndex(t.pos+s+1),c={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},u=this.createEntityHandle_(n,t.pos),l=this.entityManager_.renderToElement(n,u);l&&(c.replacedWith=l);var p=r.markText(a,h,c);o.push(p),u.setMarker(p)}t.attachObject({clear:function(){for(var t=0;t<o.length;t++)o[t].clear()},update:function(t){for(var e=v.fromAttributes(t),n=0;n<o.length;n++)i.entityManager_.updateElement(e,o[n].replacedWith)}}),this.queueRefresh_()},r.prototype.queueRefresh_=function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout((function(){t.codeMirror.refresh(),t.refreshTimer_=null}),0))},r.prototype.createEntityHandle_=function(t,e){var n=null,r=this;function i(){if(n){var t=n.find();return t?r.codeMirror.indexFromPos(t.from):null}return e}return{find:i,remove:function(){var t=i();null!=t&&(r.codeMirror.focus(),r.removeText(t,t+1))},replace:function(e){var n=p,o=n+"_",s=i();r.updateTextAttributes(s,s+1,(function(r){for(var i in r)delete r[i];for(var s in r[n]=t.type,e)r[o+s]=e[s]}))},setMarker:function(t){n=t}}},r.prototype.lineClassRemover_=function(t){var e=this.codeMirror,n=e.getLineHandle(t);return{clear:function(){e.removeLineClass(n,"text",".*")}}},r.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},r.prototype.onCodeMirrorBeforeChange_=function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var n=[],r=0;r<e.text.length;r++){var s=e.text[r];s=s.replace(new RegExp("["+i+o+"]","g"),""),n.push(s)}e.update(e.from,e.to,n)}},r.prototype.onCodeMirrorChange_=function(t,e){if("object"==typeof e.from){for(var n=[];e;)n.push(e),e=e.next;e=n}for(var r=this.convertCoordinateSystemForChanges_(e),i=[],o=0;o<r.length;o++){var s=r[o],a=s.start;s.end;var c,u=s.text,l=s.removed,p=s.origin;if(l.length>0){for(var d=this.annotationList_.getAnnotatedSpansForSpan(new N(a,l.length)),f=0,g=0;g<d.length;g++){var m=d[g];i.push({start:a,end:a+m.length,removedAttributes:m.annotation.attributes,removed:l.substr(f,m.length),attributes:{},text:"",origin:s.origin}),f+=m.length}this.annotationList_.removeSpan(new N(a,l.length))}if(u.length>0)"+input"===s.origin||"paste"===s.origin?c=this.currentAttributes_||{}:p in this.outstandingChanges_?(c=this.outstandingChanges_[p].attributes,p=this.outstandingChanges_[p].origOrigin,delete this.outstandingChanges_[p]):c={},this.annotationList_.insertAnnotatedSpan(new N(a,u.length),new h(c)),i.push({start:a,end:a,removedAttributes:{},removed:"",text:u,attributes:c,origin:p})}this.markLineSentinelCharactersForChanges_(e),i.length>0&&this.trigger("change",this,i)},r.prototype.convertCoordinateSystemForChanges_=function(t){var e=this,n=function(t){return e.codeMirror.indexFromPos(t)};function r(t,e){return function(n){return s(n,e.from)?t(n):s(e.to,n)?t({line:n.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<n.line?n.ch:e.text.length<=1?n.ch-(e.to.ch-e.from.ch)+a(e.text):n.ch-e.to.ch+(r=e.text,r[r.length-1]).length})+a(e.removed)-a(e.text):e.from.line===n.line?t(e.from)+n.ch-e.from.ch:t(e.from)+a(e.removed.slice(0,n.line-e.from.line))+1+n.ch;var r}}for(var i=[],o=t.length-1;o>=0;o--){var h=t[o],c=(n=r(n,h))(h.from),u=h.removed.join("\n"),l=h.text.join("\n");i.unshift({start:c,end:c+u.length,removed:u,text:l,origin:h.origin})}return i},r.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,n=-1,r=0;r<t.length;r++){var o=t[r],s=o.from.line;o.from.ch,(o.removed.length>1||o.removed[0].indexOf(i)>=0)&&(e=Math.min(e,s),n=Math.max(n,s)),o.text.length>1?(e=Math.min(e,s),n=Math.max(n,s+o.text.length-1)):o.text[0].indexOf(i)>=0&&(e=Math.min(e,s),n=Math.max(n,s))}n=Math.min(n,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,n)},r.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(t<Number.MAX_VALUE)for(;t>0&&this.lineIsListItemOrIndented_(t-1);)t--;if(e>-1)for(var n=this.codeMirror.lineCount();e+1<n&&this.lineIsListItemOrIndented_(e+1);)e++;for(var r=[],o=this.codeMirror,s=t;s<=e;s++){var a=o.getLine(s),h=o.getLineHandle(s);if(o.removeLineClass(h,"text",".*"),a.length>0)for(var c=a.indexOf(i);c>=0;){for(var u=c;c<a.length&&a[c]===i;){for(var l=o.findMarksAt({line:s,ch:c}),p=0;p<l.length;p++)l[p].isForLineSentinel&&l[p].clear();c++}this.markLineSentinelCharacters_(s,u,c,r),c=a.indexOf(i,c)}else r=[]}return e},r.prototype.markLineSentinelCharacters_=function(t,e,n,r){var i=this.codeMirror,o=null,s=null,a=function(){var t=s.find();return t?t.from.line:null};if(0===e){var h=this.getLineAttributes_(t),c=h[m],u=h[f]||0;for(c&&0===u&&(u=1);u>=r.length;)r.push(1);"o"===c?(o=this.makeOrderedListElement_(r[u]),r[u]++):"u"===c?(o=this.makeUnorderedListElement_(),r[u]=1):"t"===c?(o=this.makeTodoListElement_(!1,a),r[u]=1):"tc"===c&&(o=this.makeTodoListElement_(!0,a),r[u]=1);var l=this.getClassNameForAttributes_(h);""!==l&&this.codeMirror.addLineClass(t,"text",l),r[u+1]=1}var p={inclusiveLeft:!0,collapsed:!0};o&&(p.replacedWith=o),(s=i.markText({line:t,ch:e},{line:t,ch:n},p)).isForLineSentinel=!0},r.prototype.makeOrderedListElement_=function(e){return t.elt("div",e+".",{class:"firepad-list-left"})},r.prototype.makeUnorderedListElement_=function(){return t.elt("div","•",{class:"firepad-list-left"})},r.prototype.toggleTodo=function(t){var e,n=m,r=this.getCurrentLineAttributes_();!(n in r)||"t"!==r[n]&&"tc"!==r[n]?e="t":"t"===r[n]?e="tc":"tc"===r[n]&&(e=!!t&&"t"),this.setLineAttribute(n,e)},r.prototype.makeTodoListElement_=function(e,n){var r={type:"checkbox",class:"firepad-todo-left"};e&&(r.checked=!0);var i=t.elt("input",!1,r),o=this;return t.on(i,"click",t.stopEventAnd((function(t){o.codeMirror.setCursor({line:n(),ch:1}),o.toggleTodo(!0)}))),i},r.prototype.lineIsListItemOrIndented_=function(t){var e=this.getLineAttributes_(t);return!1!==(e[m]||!1)||0!==(e[f]||0)},r.prototype.onCursorActivity_=function(){var t=this;setTimeout((function(){t.updateCurrentAttributes_()}),1)},r.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},r.prototype.updateCurrentAttributes_=function(){var e=this.codeMirror,n=e.indexFromPos(e.getCursor("anchor")),r=e.indexFromPos(e.getCursor("head")),o=r;if(n>r){for(;o<this.end();){var s=this.getRange(o,o+1);if("\n"!==s&&s!==i)break;o++}o<this.end()&&o++}else for(;o>0&&("\n"===(s=this.getRange(o-1,o))||s===i);)o--;var a=this.annotationList_.getAnnotatedSpansForPos(o);this.currentAttributes_={};var h={};for(var c in a.length>0&&!(d in a[0].annotation.attributes)?h=a[0].annotation.attributes:a.length>1&&(t.assert(!(d in a[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),h=a[1].annotation.attributes),h)"l"!==c&&"lt"!==c&&"li"!==c&&0!==c.indexOf(p)&&(this.currentAttributes_[c]=h[c])},r.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),n=t.getCursor("head"),r=n.line;return 0===n.ch&&e.line<n.line&&r--,this.getLineAttributes_(r)},r.prototype.getLineAttributes_=function(e){var n={},r=this.codeMirror.getLine(e);if(r.length>0&&r[0]===i){var o=this.codeMirror.indexFromPos({line:e,ch:0}),s=this.annotationList_.getAnnotatedSpansForSpan(new N(o,1));for(var a in t.assert(1===s.length),s[0].annotation.attributes)n[a]=s[0].annotation.attributes[a]}return n},r.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new N(0,this.end()),(function(t,e){return new h({})}))},r.prototype.newline=function(){var t=this.codeMirror,e=this;if(this.emptySelection_()){var n=t.getCursor("head").line,r=this.getLineAttributes_(n),i=r[m];i&&1===t.getLine(n).length?this.updateLineAttributes(n,n,(function(t){delete t[m],delete t[f]})):(t.replaceSelection("\n","end","+input"),this.updateLineAttributes(n+1,n+1,(function(t){for(var o in r)t[o]=r[o];"tc"===i&&(t[m]="t"),e.trigger("newLine",{line:n+1,attr:t})})))}else t.replaceSelection("\n","end","+input")},r.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),n=this.getLineAttributes_(e.line),r=n[m],i=n[f],o=this.emptySelection_()&&1===e.ch;o&&r?this.updateLineAttributes(e.line,e.line,(function(t){delete t[m],delete t[f]})):o&&i&&i>0?this.unindent():t.deleteH(-1,"char")},r.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),n=t.getLine(e.line),r=this.areLineSentinelCharacters_(n),o=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&r&&o[0]===i?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")},r.prototype.indent=function(){this.updateLineAttributesForSelection((function(t){var e=t[f],n=t[m];e?t[f]++:t[f]=n?2:1}))},r.prototype.unindent=function(){this.updateLineAttributesForSelection((function(t){var e=t[f];e&&e>1?t[f]=e-1:(delete t[m],delete t[f])}))},r.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(i,"g"),"")},r.prototype.areLineSentinelCharacters_=function(t){for(var e=0;e<t.length;e++)if(t[e]!==i)return!1;return!0},h.prototype.equals=function(t){if(!(t instanceof h))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},r}(),H=function(e){function n(t){this.imageInsertionUI=t,this.element_=this.makeElement_()}return t.makeEventEmitter(n,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image"]),n.prototype.element=function(){return this.element_},n.prototype.makeButton_=function(e,n){var r=this;n=n||e;var i=t.elt("a",[t.elt("span","",{class:"firepad-tb-"+n})],{class:"firepad-btn"});return t.on(i,"click",t.stopEventAnd((function(){r.trigger(e)}))),i},n.prototype.makeElement_=function(){var e=this,n=this.makeFontDropdown_(),r=this.makeFontSizeDropdown_(),i=this.makeColorDropdown_(),o=[t.elt("div",[n],{class:"firepad-btn-group"}),t.elt("div",[r],{class:"firepad-btn-group"}),t.elt("div",[i],{class:"firepad-btn-group"}),t.elt("div",[e.makeButton_("bold"),e.makeButton_("italic"),e.makeButton_("underline"),e.makeButton_("strike","strikethrough")],{class:"firepad-btn-group"}),t.elt("div",[e.makeButton_("unordered-list","list-2"),e.makeButton_("ordered-list","numbered-list"),e.makeButton_("todo-list","list")],{class:"firepad-btn-group"}),t.elt("div",[e.makeButton_("indent-decrease"),e.makeButton_("indent-increase")],{class:"firepad-btn-group"}),t.elt("div",[e.makeButton_("left","paragraph-left"),e.makeButton_("center","paragraph-center"),e.makeButton_("right","paragraph-right")],{class:"firepad-btn-group"}),t.elt("div",[e.makeButton_("undo"),e.makeButton_("redo")],{class:"firepad-btn-group"})];e.imageInsertionUI&&o.push(t.elt("div",[e.makeButton_("insert-image")],{class:"firepad-btn-group"}));var s=t.elt("div",o,{class:"firepad-toolbar-wrapper"}),a=t.elt("div",null,{class:"firepad-toolbar"});return a.appendChild(s),a},n.prototype.makeFontDropdown_=function(){for(var e=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],n=[],r=0;r<e.length;r++){var i=t.elt("span",e[r]);i.setAttribute("style","font-family:"+e[r]),n.push({content:i,value:e[r]})}return this.makeDropdown_("Font","font",n)},n.prototype.makeFontSizeDropdown_=function(){for(var e=[9,10,12,14,18,24,32,42],n=[],r=0;r<e.length;r++){var i=t.elt("span",e[r].toString());i.setAttribute("style","font-size:"+e[r]+"px; line-height:"+(e[r]-6)+"px;"),n.push({content:i,value:e[r]})}return this.makeDropdown_("Size","font-size",n,"px")},n.prototype.makeColorDropdown_=function(){for(var e=["black","red","green","blue","yellow","cyan","magenta","grey"],n=[],r=0;r<e.length;r++){var i=t.elt("div");i.className="firepad-color-dropdown-item",i.setAttribute("style","background-color:"+e[r]),n.push({content:i,value:e[r]})}return this.makeDropdown_("Color","color",n)},n.prototype.makeDropdown_=function(e,n,r,i){i=i||"";var o=this,s=t.elt("a",e+" ▾",{class:"firepad-btn firepad-dropdown"}),a=t.elt("ul",[],{class:"firepad-dropdown-menu"});s.appendChild(a);var h=!1;var c=!1;function u(){h&&(a.style.display="",t.off(document,"click",u,!0),h=!1),c=!0,setTimeout((function(){c=!1}),0)}function l(e,r){"object"!=typeof e&&(e=document.createTextNode(String(e)));var s=t.elt("a",[e]);t.on(s,"click",t.stopEventAnd((function(){u(),o.trigger(n,r+i)}))),a.appendChild(s)}for(var p=0;p<r.length;p++){l(r[p].content,r[p].value)}return t.on(s,"click",t.stopEventAnd((function(){c||h||(a.style.display="block",t.on(document,"click",u,!0),h=!0)}))),s},n}();var j=function(t,e){return function(){return t.apply(e,arguments)}},W=[].slice,z=function(){function t(t){var e;this.onCursorActivity=j(this.onCursorActivity,this),this.onFocus=j(this.onFocus,this),this.onBlur=j(this.onBlur,this),this.onChange=j(this.onChange,this),this.ace=t,this.aceSession=this.ace.getSession(),this.aceDoc=this.aceSession.getDocument(),this.aceDoc.setNewLineMode("unix"),this.grabDocumentState(),this.ace.on("change",this.onChange),this.ace.on("blur",this.onBlur),this.ace.on("focus",this.onFocus),this.aceSession.selection.on("changeCursor",this.onCursorActivity),null==this.aceRange&&(this.aceRange=(null!=(e=ace.require)?e:require)("ace/range").Range)}return t.prototype.ignoreChanges=!1,t.prototype.grabDocumentState=function(){return this.lastDocLines=this.aceDoc.getAllLines(),this.lastCursorRange=this.aceSession.selection.getRange()},t.prototype.detach=function(){return this.ace.removeListener("change",this.onChange),this.ace.removeListener("blur",this.onBlur),this.ace.removeListener("focus",this.onFocus),this.aceSession.selection.removeListener("changeCursor",this.onCursorActivity)},t.prototype.onChange=function(t){var e;if(!this.ignoreChanges)return e=this.operationFromACEChange(t),this.trigger.apply(this,["change"].concat(W.call(e))),this.grabDocumentState()},t.prototype.onBlur=function(){if(this.ace.selection.isEmpty())return this.trigger("blur")},t.prototype.onFocus=function(){return this.trigger("focus")},t.prototype.onCursorActivity=function(){return setTimeout((t=this,function(){return t.trigger("cursorActivity")}),0);var t},t.prototype.operationFromACEChange=function(t){var e,r,i,o,s,a,h;return t.data?("insertLines"===(o=(r=t.data).action)||"removeLines"===o?(h=r.lines.join("\n")+"\n",r.action.replace("Lines","")):(h=r.text.replace(this.aceDoc.getNewLineCharacter(),"\n"),r.action.replace("Text","")),a=this.indexFromPos(r.range.start)):(h=t.lines.join("\n"),a=this.indexFromPos(t.start)),s=this.lastDocLines.join("\n").length-a,"remove"===t.action&&(s-=h.length),i=(new n).retain(a).insert(h).retain(s),e=(new n).retain(a).delete(h).retain(s),"remove"===t.action?[e,i]:[i,e]},t.prototype.applyOperationToACE=function(t){var e,n,r,i,o,s,a,h;for(n=0,r=0,i=(a=t.ops).length;r<i;r++)(o=a[r]).isRetain()?n+=o.chars:o.isInsert()?(this.aceDoc.insert(this.posFromIndex(n),o.text),n+=o.text.length):o.isDelete()&&(e=this.posFromIndex(n),h=this.posFromIndex(n+o.chars),s=this.aceRange.fromPoints(e,h),this.aceDoc.remove(s));return this.grabDocumentState()},t.prototype.posFromIndex=function(t){var e,n,r,i,o;for(o=e=0,n=(i=this.aceDoc.$lines).length;e<n&&!(t<=(r=i[o]).length);o=++e)t-=r.length+1;return{row:o,column:t}},t.prototype.indexFromPos=function(t,e){var n,r,i,o;for(null==e&&(e=this.lastDocLines),r=0,n=i=0,o=t.row;0<=o?i<o:i>o;n=0<=o?++i:--i)r+=this.lastDocLines[n].length+1;return r+t.column},t.prototype.getValue=function(){return this.aceDoc.getValue()},t.prototype.getCursor=function(){var t,e,n,r,i;try{i=this.indexFromPos(this.aceSession.selection.getRange().start,this.aceDoc.$lines),e=this.indexFromPos(this.aceSession.selection.getRange().end,this.aceDoc.$lines)}catch(r){try{i=this.indexFromPos(this.lastCursorRange.start),e=this.indexFromPos(this.lastCursorRange.end)}catch(r){t=r,console.log("Couldn't figure out the cursor range:",t,"-- setting it to 0:0."),i=(n=[0,0])[0],e=n[1]}}return i>e&&(i=(r=[e,i])[0],e=r[1]),new L(i,e)},t.prototype.setCursor=function(t){var e,n,r;return r=this.posFromIndex(t.position),e=this.posFromIndex(t.selectionEnd),t.position>t.selectionEnd&&(r=(n=[e,r])[0],e=n[1]),this.aceSession.selection.setSelectionRange(new this.aceRange(r.row,r.column,e.row,e.column))},t.prototype.setOtherCursor=function(t,e,n){var r,i,o,s,a,h,c,u,l;return null==this.otherCursors&&(this.otherCursors={}),(o=this.otherCursors[n])&&(o.start.detach(),o.end.detach(),this.aceSession.removeMarker(o.id)),u=this.posFromIndex(t.position),s=this.posFromIndex(t.selectionEnd),t.selectionEnd<t.position&&(u=(h=[s,u])[0],s=h[1]),r="other-client-selection-"+e.replace("#",""),(a=t.position===t.selectionEnd)&&(r=r.replace("selection","cursor")),i="."+r+" {\n  position: absolute;\n  background-color: "+(a?"transparent":e)+";\n  border-left: 2px solid "+e+";\n}",this.addStyleRule(i),this.otherCursors[n]=o=new this.aceRange(u.row,u.column,s.row,s.column),c=this,o.clipRows=function(){var t;return(t=c.aceRange.prototype.clipRows.apply(this,arguments)).isEmpty=function(){return!1},t},o.start=this.aceDoc.createAnchor(o.start),o.end=this.aceDoc.createAnchor(o.end),o.id=this.aceSession.addMarker(o,r,"text"),{clear:(l=this,function(){return o.start.detach(),o.end.detach(),l.aceSession.removeMarker(o.id)})}},t.prototype.addStyleRule=function(t){var e;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},e=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet),!this.addedStyleRules[t]))return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(){var t,e,n,r;return e=arguments[0],t=2<=arguments.length?W.call(arguments,1):[],null!=(n=this.callbacks)&&null!=(r=n[e])?r.apply(this,t):void 0},t.prototype.applyOperation=function(t){return t.isNoop()||(this.ignoreChanges=!0),this.applyOperationToACE(t),this.ignoreChanges=!1},t.prototype.registerUndo=function(t){return this.ace.undo=t},t.prototype.registerRedo=function(t){return this.ace.redo=t},t.prototype.invertOperation=function(t){return t.invert(this.getValue())},t}(),U=function(t,e,n){return"."+t+" {\n  position: relative;\nbackground-color: "+e+";\nborder-left: 2px solid "+n+";\n}"},q=function(t,e){if("undefined"==typeof document||null===document)return!1;if(-1===this.addedStyleRules.indexOf(t)){var n=document.createElement("style"),r=document.createTextNode(e);n.appendChild(r),document.head.appendChild(n),this.addedStyleRules.push(t)}},V=function(){function t(t){if(!t||"function"!=typeof t.getModel)throw new Error("MonacoAdapter: Incorrect Parameter Recieved in constructor, expected valid Monaco Instance");this.monaco=t,this.monacoModel=this.monaco.getModel(),this.lastDocLines=this.monacoModel.getLinesContent(),this.lastCursorRange=this.monaco.getSelection(),this.callbacks={},this.otherCursors=[],this.addedStyleRules=[],this.ignoreChanges=!1,this.onChange=this.onChange.bind(this),this.onBlur=this.onBlur.bind(this),this.onFocus=this.onFocus.bind(this),this.onCursorActivity=this.onCursorActivity.bind(this),this.changeHandler=this.monaco.onDidChangeModelContent(this.onChange),this.didBlurHandler=this.monaco.onDidBlurEditorWidget(this.onBlur),this.didFocusHandler=this.monaco.onDidFocusEditorWidget(this.onFocus),this.didChangeCursorPositionHandler=this.monaco.onDidChangeCursorPosition(this.onCursorActivity)}return t.prototype.detach=function(){this.changeHandler.dispose(),this.didBlurHandler.dispose(),this.didFocusHandler.dispose(),this.didChangeCursorPositionHandler.dispose()},t.prototype.getCursor=function(){var t=this.monaco.getSelection();null==t&&(t=this.lastCursorRange);var e=t.getStartPosition(),n=t.getEndPosition(),r=this.monacoModel.getOffsetAt(e),i=this.monacoModel.getOffsetAt(n);if(r>i){var o=[i,r];r=o[0],i=o[1]}return new L(r,i)},t.prototype.setCursor=function(t){var e=t.position,n=t.selectionEnd,r=this.monacoModel.getPositionAt(e),i=this.monacoModel.getPositionAt(n);if(e>n){var o=[i,r];r=o[0],i=o[1]}this.monaco.setSelection(new monaco.Range(r.lineNumber,r.column,i.lineNumber,i.column))},t.prototype.setOtherCursor=function(t,e,n){if("object"!=typeof t||"number"!=typeof t.position||"number"!=typeof t.selectionEnd)return!1;if("string"!=typeof e||!e.match(/^#[a-fA-F0-9]{3,6}$/))return!1;var r=t.position,i=t.selectionEnd;if(r<0||i<0)return!1;var o=this.otherCursors.find((function(t){return t.clientID===n}));o||(o={clientID:n,decoration:[]},this.otherCursors.push(o)),o.decoration=this.monaco.deltaDecorations(o.decoration,[]);var s,a,h="other-client-selection-"+e.replace("#","");r===i?(h=h.replace("selection","cursor"),s=U(h,"transparent",e),a=q.call(this,h,s)):(s=U(h,e,e),a=q.call(this,h,s)),0==a&&console.log("Monaco Adapter: Failed to add some css style.\nPlease make sure you're running on supported environment.");var c=this.monacoModel.getPositionAt(r),u=this.monacoModel.getPositionAt(i);if(r>i){var l=[u,c];c=l[0],u=l[1]}o.decoration=this.monaco.deltaDecorations(o.decoration,[{range:new monaco.Range(c.lineNumber,c.column,u.lineNumber,u.column),options:{className:h}}]);var p=this;return{clear:function(){o.decoration=p.monaco.deltaDecorations(o.decoration,[])}}},t.prototype.registerCallbacks=function(t){this.callbacks=Object.assign({},this.callbacks,t)},t.prototype.registerUndo=function(t){if("function"!=typeof t)throw new Error("MonacoAdapter: registerUndo method expects a callback function in parameter");this.callbacks.undo=t},t.prototype.registerRedo=function(t){if("function"!=typeof t)throw new Error("MonacoAdapter: registerRedo method expects a callback function in parameter");this.callbacks.redo=t},t.prototype.operationFromMonacoChanges=function(t,e,r){var i,o,s,a=t.text,h=t.rangeLength,c=t.rangeOffset,u=e.length+r-c;return 0===a.length&&h>0?(s=e.slice(c,c+h),i=(new n).retain(c).delete(h).retain(u-h),o=(new n).retain(c).insert(s).retain(u-h)):a.length>0&&h>0?(s=e.slice(c,c+h),i=(new n).retain(c).delete(h).insert(a).retain(u-h),o=(new n).retain(c).delete(a.length).insert(s).retain(u-h)):(i=(new n).retain(c).insert(a).retain(u),o=(new n).retain(c).delete(a).retain(u)),[i,o]},t.prototype.onChange=function(t){var e=this;if(!this.ignoreChanges){var r=this.lastDocLines.join(this.monacoModel.getEOL()),i=0;if(!t.changes){var o=(new n).retain(r.length);this.trigger("change",o,o)}t.changes.forEach((function(t){var n=e.operationFromMonacoChanges(t,r,i);i+=n[0].targetLength-n[0].baseLength,e.trigger.apply(e,["change"].concat(n))})),this.lastDocLines=this.monacoModel.getLinesContent()}},t.prototype.trigger=function(t){if(this.callbacks.hasOwnProperty(t)){var e=this.callbacks[t];0;var n=[];if(arguments.length>1)for(var r=1;r<arguments.length;r++)n.push(arguments[r]);e.apply(null,n)}},t.prototype.onBlur=function(){this.monaco.getSelection().isEmpty()&&this.trigger("blur")},t.prototype.onFocus=function(){this.trigger("focus")},t.prototype.onCursorActivity=function(){var t=this;setTimeout((function(){return t.trigger("cursorActivity")}),1)},t.prototype.applyOperation=function(t){t.isNoop()||(this.ignoreChanges=!0);var e=t.ops,n=0,r=this;e.forEach((function(t){if(t.isRetain())n+=t.chars;else if(t.isInsert()){var e=r.monacoModel.getPositionAt(n);r.monaco.executeEdits("my-source",[{range:new monaco.Range(e.lineNumber,e.column,e.lineNumber,e.column),text:t.text,forceMoveMarkers:!0}]),n+=t.text.length}else if(t.isDelete()){var i=r.monacoModel.getPositionAt(n),o=r.monacoModel.getPositionAt(n+t.chars);r.monaco.executeEdits("my-source",[{range:new monaco.Range(i.lineNumber,i.column,o.lineNumber,o.column),text:"",forceMoveMarkers:!0}])}})),this.lastDocLines=this.monacoModel.getLinesContent(),this.ignoreChanges=!1},t.prototype.invertOperation=function(t){t.invert(this.getValue())},t}();let Y="lc,34,7n,7,7b,19,,,,2,,2,,,20,b,1c,l,g,,2t,7,2,6,2,2,,4,z,,u,r,2j,b,1m,9,9,,o,4,,9,,3,,5,17,3,3b,f,,w,1j,,,,4,8,4,,3,7,a,2,t,,1m,,,,2,4,8,,9,,a,2,q,,2,2,1l,,4,2,4,2,2,3,3,,u,2,3,,b,2,1l,,4,5,,2,4,,k,2,m,6,,,1m,,,2,,4,8,,7,3,a,2,u,,1n,,,,c,,9,,14,,3,,1l,3,5,3,,4,7,2,b,2,t,,1m,,2,,2,,3,,5,2,7,2,b,2,s,2,1l,2,,,2,4,8,,9,,a,2,t,,20,,4,,2,3,,,8,,29,,2,7,c,8,2q,,2,9,b,6,22,2,r,,,,,,1j,e,,5,,2,5,b,,10,9,,2u,4,,6,,2,2,2,p,2,4,3,g,4,d,,2,2,6,,f,,jj,3,qa,3,t,3,t,2,u,2,1s,2,,7,8,,2,b,9,,19,3,3b,2,y,,3a,3,4,2,9,,6,3,63,2,2,,1m,,,7,,,,,2,8,6,a,2,,1c,h,1r,4,1c,7,,,5,,14,9,c,2,w,4,2,2,,3,1k,,,2,3,,,3,1m,8,2,2,48,3,,d,,7,4,,6,,3,2,5i,1m,,5,ek,,5f,x,2da,3,3x,,2o,w,fe,6,2x,2,n9w,4,,a,w,2,28,2,7k,,3,,4,,p,2,5,,47,2,q,i,d,,12,8,p,b,1a,3,1c,,2,4,2,2,13,,1v,6,2,2,2,2,c,,8,,1b,,1f,,,3,2,2,5,2,,,16,2,8,,6m,,2,,4,,fn4,,kh,g,g,g,a6,2,gt,,6a,,45,5,1ae,3,,2,5,4,14,3,4,,4l,2,fx,4,ar,2,49,b,4w,,1i,f,1k,3,1d,4,2,2,1x,3,10,5,,8,1q,,c,2,1g,9,a,4,2,,2n,3,2,,,2,6,,4g,,3,8,l,2,1l,2,,,,,m,,e,7,3,5,5f,8,2,3,,,n,,29,,2,6,,,2,,,2,,2,6j,,2,4,6,2,,2,r,2,2d,8,2,,,2,2y,,,,2,6,,,2t,3,2,4,,5,77,9,,2,6t,,a,2,,,4,,40,4,2,2,4,,w,a,14,6,2,4,8,,9,6,2,3,1a,d,,2,ba,7,,6,,,2a,m,2,7,,2,,2,3e,6,3,,,2,,7,,,20,2,3,,,,9n,2,f0b,5,1n,7,t4,,1r,4,29,,f5k,2,43q,,,3,4,5,8,8,2,7,u,4,44,3,1iz,1j,4,1e,8,,e,,m,5,,f,11s,7,,h,2,7,,2,,5,79,7,c5,4,15s,7,31,7,240,5,gx7k,2o,3k,6o".split(",").map((t=>t?parseInt(t,36):1));for(let t=1;t<Y.length;t++)Y[t]+=Y[t-1];var J=function(t){return t[t.Simple=0]="Simple",t[t.TrackDel=1]="TrackDel",t[t.TrackBefore=2]="TrackBefore",t[t.TrackAfter=3]="TrackAfter",t}(J||(J={}));class K{constructor(t,e){this.type=t,this.value=e}static define(){return new $}}class ${of(t){return new K(this,t)}}let X;try{X=new RegExp("[\\p{Alphabetic}\\p{Number}_]","u")}catch(t){}J.TrackDel;class G{constructor(t,e,n){this.from=t,this.to=e,this.value=n}static create(t,e,n){return new G(t,e,n)}}function Q(t,e){return t.from-e.from||t.value.startSide-e.value.startSide}class Z{constructor(t,e,n,r){this.from=t,this.to=e,this.value=n,this.maxPoint=r}get length(){return this.to[this.to.length-1]}findIndex(t,e,n,r=0){let i=n?this.to:this.from;for(let o=r,s=i.length;;){if(o==s)return o;let r=o+s>>1,a=i[r]-t||(n?this.value[r].endSide:this.value[r].startSide)-e;if(r==o)return a>=0?o:s;a>=0?s=r:o=r+1}}between(t,e,n,r){for(let i=this.findIndex(e,-1e9,!0),o=this.findIndex(n,1e9,!1,i);i<o;i++)if(!1===r(this.from[i]+t,this.to[i]+t,this.value[i]))return!1}map(t,e){let n=[],r=[],i=[],o=-1,s=-1;for(let a=0;a<this.value.length;a++){let h,c,u=this.value[a],l=this.from[a]+t,p=this.to[a]+t;if(l==p){let t=e.mapPos(l,u.startSide,u.mapMode);if(null==t)continue;if(h=c=t,u.startSide!=u.endSide&&(c=e.mapPos(l,u.endSide),c<h))continue}else if(h=e.mapPos(l,u.startSide),c=e.mapPos(p,u.endSide),h>c||h==c&&u.startSide>0&&u.endSide<=0)continue;(c-h||u.endSide-u.startSide)<0||(o<0&&(o=h),u.point&&(s=Math.max(s,c-h)),n.push(u),r.push(h-o),i.push(c-o))}return{mapped:n.length?new Z(r,i,n,s):null,pos:o}}}class tt{constructor(t,e,n,r){this.chunkPos=t,this.chunk=e,this.nextLayer=n,this.maxPoint=r}static create(t,e,n,r){return new tt(t,e,n,r)}get length(){let t=this.chunk.length-1;return t<0?0:Math.max(this.chunkEnd(t),this.nextLayer.length)}get size(){if(this.isEmpty)return 0;let t=this.nextLayer.size;for(let e of this.chunk)t+=e.value.length;return t}chunkEnd(t){return this.chunkPos[t]+this.chunk[t].length}update(t){let{add:e=[],sort:n=!1,filterFrom:r=0,filterTo:i=this.length}=t,o=t.filter;if(0==e.length&&!o)return this;if(n&&(e=e.slice().sort(Q)),this.isEmpty)return e.length?tt.of(e):this;let s=new rt(this,null,-1).goto(0),a=0,h=[],c=new et;for(;s.value||a<e.length;)if(a<e.length&&(s.from-e[a].from||s.startSide-e[a].value.startSide)>=0){let t=e[a++];c.addInner(t.from,t.to,t.value)||h.push(t)}else 1==s.rangeIndex&&s.chunkIndex<this.chunk.length&&(a==e.length||this.chunkEnd(s.chunkIndex)<e[a].from)&&(!o||r>this.chunkEnd(s.chunkIndex)||i<this.chunkPos[s.chunkIndex])&&c.addChunk(this.chunkPos[s.chunkIndex],this.chunk[s.chunkIndex])?s.nextChunk():((!o||r>s.to||i<s.from||o(s.from,s.to,s.value))&&(c.addInner(s.from,s.to,s.value)||h.push(G.create(s.from,s.to,s.value))),s.next());return c.finishInner(this.nextLayer.isEmpty&&!h.length?tt.empty:this.nextLayer.update({add:h,filter:o,filterFrom:r,filterTo:i}))}map(t){if(t.empty||this.isEmpty)return this;let e=[],n=[],r=-1;for(let i=0;i<this.chunk.length;i++){let o=this.chunkPos[i],s=this.chunk[i],a=t.touchesRange(o,o+s.length);if(!1===a)r=Math.max(r,s.maxPoint),e.push(s),n.push(t.mapPos(o));else if(!0===a){let{mapped:i,pos:a}=s.map(o,t);i&&(r=Math.max(r,i.maxPoint),e.push(i),n.push(a))}}let i=this.nextLayer.map(t);return 0==e.length?i:new tt(n,e,i||tt.empty,r)}between(t,e,n){if(!this.isEmpty){for(let r=0;r<this.chunk.length;r++){let i=this.chunkPos[r],o=this.chunk[r];if(e>=i&&t<=i+o.length&&!1===o.between(i,t-i,e-i,n))return}this.nextLayer.between(t,e,n)}}iter(t=0){return it.from([this]).goto(t)}get isEmpty(){return this.nextLayer==this}static iter(t,e=0){return it.from(t).goto(e)}static compare(t,e,n,r,i=-1){let o=t.filter((t=>t.maxPoint>0||!t.isEmpty&&t.maxPoint>=i)),s=e.filter((t=>t.maxPoint>0||!t.isEmpty&&t.maxPoint>=i)),a=nt(o,s,n),h=new st(o,a,i),c=new st(s,a,i);n.iterGaps(((t,e,n)=>at(h,t,c,e,n,r))),n.empty&&0==n.length&&at(h,0,c,0,0,r)}static eq(t,e,n=0,r){null==r&&(r=1e9);let i=t.filter((t=>!t.isEmpty&&e.indexOf(t)<0)),o=e.filter((e=>!e.isEmpty&&t.indexOf(e)<0));if(i.length!=o.length)return!1;if(!i.length)return!0;let s=nt(i,o),a=new st(i,s,0).goto(n),h=new st(o,s,0).goto(n);for(;;){if(a.to!=h.to||!ht(a.active,h.active)||a.point&&(!h.point||!a.point.eq(h.point)))return!1;if(a.to>r)return!0;a.next(),h.next()}}static spans(t,e,n,r,i=-1){let o=new st(t,null,i).goto(e),s=e,a=o.openStart;for(;;){let t=Math.min(o.to,n);if(o.point?(r.point(s,t,o.point,o.activeForPoint(o.to),a,o.pointRank),a=o.openEnd(t)+(o.to>t?1:0)):t>s&&(r.span(s,t,o.active,a),a=o.openEnd(t)),o.to>n)break;s=o.to,o.next()}return a}static of(t,e=!1){let n=new et;for(let r of t instanceof G?[t]:e?function(t){if(t.length>1)for(let e=t[0],n=1;n<t.length;n++){let r=t[n];if(Q(e,r)>0)return t.slice().sort(Q);e=r}return t}(t):t)n.add(r.from,r.to,r.value);return n.finish()}}tt.empty=new tt([],[],null,-1),tt.empty.nextLayer=tt.empty;class et{constructor(){this.chunks=[],this.chunkPos=[],this.chunkStart=-1,this.last=null,this.lastFrom=-1e9,this.lastTo=-1e9,this.from=[],this.to=[],this.value=[],this.maxPoint=-1,this.setMaxPoint=-1,this.nextLayer=null}finishChunk(t){this.chunks.push(new Z(this.from,this.to,this.value,this.maxPoint)),this.chunkPos.push(this.chunkStart),this.chunkStart=-1,this.setMaxPoint=Math.max(this.setMaxPoint,this.maxPoint),this.maxPoint=-1,t&&(this.from=[],this.to=[],this.value=[])}add(t,e,n){this.addInner(t,e,n)||(this.nextLayer||(this.nextLayer=new et)).add(t,e,n)}addInner(t,e,n){let r=t-this.lastTo||n.startSide-this.last.endSide;if(r<=0&&(t-this.lastFrom||n.startSide-this.last.startSide)<0)throw new Error("Ranges must be added sorted by `from` position and `startSide`");return!(r<0)&&(250==this.from.length&&this.finishChunk(!0),this.chunkStart<0&&(this.chunkStart=t),this.from.push(t-this.chunkStart),this.to.push(e-this.chunkStart),this.last=n,this.lastFrom=t,this.lastTo=e,this.value.push(n),n.point&&(this.maxPoint=Math.max(this.maxPoint,e-t)),!0)}addChunk(t,e){if((t-this.lastTo||e.value[0].startSide-this.last.endSide)<0)return!1;this.from.length&&this.finishChunk(!0),this.setMaxPoint=Math.max(this.setMaxPoint,e.maxPoint),this.chunks.push(e),this.chunkPos.push(t);let n=e.value.length-1;return this.last=e.value[n],this.lastFrom=e.from[n]+t,this.lastTo=e.to[n]+t,!0}finish(){return this.finishInner(tt.empty)}finishInner(t){if(this.from.length&&this.finishChunk(!1),0==this.chunks.length)return t;let e=tt.create(this.chunkPos,this.chunks,this.nextLayer?this.nextLayer.finishInner(t):t,this.setMaxPoint);return this.from=null,e}}function nt(t,e,n){let r=new Map;for(let e of t)for(let t=0;t<e.chunk.length;t++)e.chunk[t].maxPoint<=0&&r.set(e.chunk[t],e.chunkPos[t]);let i=new Set;for(let t of e)for(let e=0;e<t.chunk.length;e++){let o=r.get(t.chunk[e]);null==o||(n?n.mapPos(o):o)!=t.chunkPos[e]||(null==n?void 0:n.touchesRange(o,o+t.chunk[e].length))||i.add(t.chunk[e])}return i}class rt{constructor(t,e,n,r=0){this.layer=t,this.skip=e,this.minPoint=n,this.rank=r}get startSide(){return this.value?this.value.startSide:0}get endSide(){return this.value?this.value.endSide:0}goto(t,e=-1e9){return this.chunkIndex=this.rangeIndex=0,this.gotoInner(t,e,!1),this}gotoInner(t,e,n){for(;this.chunkIndex<this.layer.chunk.length;){let e=this.layer.chunk[this.chunkIndex];if(!(this.skip&&this.skip.has(e)||this.layer.chunkEnd(this.chunkIndex)<t||e.maxPoint<this.minPoint))break;this.chunkIndex++,n=!1}if(this.chunkIndex<this.layer.chunk.length){let r=this.layer.chunk[this.chunkIndex].findIndex(t-this.layer.chunkPos[this.chunkIndex],e,!0);(!n||this.rangeIndex<r)&&this.setRangeIndex(r)}this.next()}forward(t,e){(this.to-t||this.endSide-e)<0&&this.gotoInner(t,e,!0)}next(){for(;;){if(this.chunkIndex==this.layer.chunk.length){this.from=this.to=1e9,this.value=null;break}{let t=this.layer.chunkPos[this.chunkIndex],e=this.layer.chunk[this.chunkIndex],n=t+e.from[this.rangeIndex];if(this.from=n,this.to=t+e.to[this.rangeIndex],this.value=e.value[this.rangeIndex],this.setRangeIndex(this.rangeIndex+1),this.minPoint<0||this.value.point&&this.to-this.from>=this.minPoint)break}}}setRangeIndex(t){if(t==this.layer.chunk[this.chunkIndex].value.length){if(this.chunkIndex++,this.skip)for(;this.chunkIndex<this.layer.chunk.length&&this.skip.has(this.layer.chunk[this.chunkIndex]);)this.chunkIndex++;this.rangeIndex=0}else this.rangeIndex=t}nextChunk(){this.chunkIndex++,this.rangeIndex=0,this.next()}compare(t){return this.from-t.from||this.startSide-t.startSide||this.rank-t.rank||this.to-t.to||this.endSide-t.endSide}}class it{constructor(t){this.heap=t}static from(t,e=null,n=-1){let r=[];for(let i=0;i<t.length;i++)for(let o=t[i];!o.isEmpty;o=o.nextLayer)o.maxPoint>=n&&r.push(new rt(o,e,n,i));return 1==r.length?r[0]:new it(r)}get startSide(){return this.value?this.value.startSide:0}goto(t,e=-1e9){for(let n of this.heap)n.goto(t,e);for(let t=this.heap.length>>1;t>=0;t--)ot(this.heap,t);return this.next(),this}forward(t,e){for(let n of this.heap)n.forward(t,e);for(let t=this.heap.length>>1;t>=0;t--)ot(this.heap,t);(this.to-t||this.value.endSide-e)<0&&this.next()}next(){if(0==this.heap.length)this.from=this.to=1e9,this.value=null,this.rank=-1;else{let t=this.heap[0];this.from=t.from,this.to=t.to,this.value=t.value,this.rank=t.rank,t.value&&t.next(),ot(this.heap,0)}}}function ot(t,e){for(let n=t[e];;){let r=1+(e<<1);if(r>=t.length)break;let i=t[r];if(r+1<t.length&&i.compare(t[r+1])>=0&&(i=t[r+1],r++),n.compare(i)<0)break;t[r]=n,t[e]=i,e=r}}class st{constructor(t,e,n){this.minPoint=n,this.active=[],this.activeTo=[],this.activeRank=[],this.minActive=-1,this.point=null,this.pointFrom=0,this.pointRank=0,this.to=-1e9,this.endSide=0,this.openStart=-1,this.cursor=it.from(t,e,n)}goto(t,e=-1e9){return this.cursor.goto(t,e),this.active.length=this.activeTo.length=this.activeRank.length=0,this.minActive=-1,this.to=t,this.endSide=e,this.openStart=-1,this.next(),this}forward(t,e){for(;this.minActive>-1&&(this.activeTo[this.minActive]-t||this.active[this.minActive].endSide-e)<0;)this.removeActive(this.minActive);this.cursor.forward(t,e)}removeActive(t){ct(this.active,t),ct(this.activeTo,t),ct(this.activeRank,t),this.minActive=lt(this.active,this.activeTo)}addActive(t){let e=0,{value:n,to:r,rank:i}=this.cursor;for(;e<this.activeRank.length&&this.activeRank[e]<=i;)e++;ut(this.active,e,n),ut(this.activeTo,e,r),ut(this.activeRank,e,i),t&&ut(t,e,this.cursor.from),this.minActive=lt(this.active,this.activeTo)}next(){let t=this.to,e=this.point;this.point=null;let n=this.openStart<0?[]:null,r=0;for(;;){let i=this.minActive;if(i>-1&&(this.activeTo[i]-this.cursor.from||this.active[i].endSide-this.cursor.startSide)<0){if(this.activeTo[i]>t){this.to=this.activeTo[i],this.endSide=this.active[i].endSide;break}this.removeActive(i),n&&ct(n,i)}else{if(!this.cursor.value){this.to=this.endSide=1e9;break}if(this.cursor.from>t){this.to=this.cursor.from,this.endSide=this.cursor.startSide;break}{let i=this.cursor.value;if(i.point){if(!(e&&this.cursor.to==this.to&&this.cursor.from<this.cursor.to)){this.point=i,this.pointFrom=this.cursor.from,this.pointRank=this.cursor.rank,this.to=this.cursor.to,this.endSide=i.endSide,this.cursor.from<t&&(r=1),this.cursor.next(),this.forward(this.to,this.endSide);break}this.cursor.next()}else this.addActive(n),this.cursor.next()}}}if(n){let e=0;for(;e<n.length&&n[e]<t;)e++;this.openStart=e+r}}activeForPoint(t){if(!this.active.length)return this.active;let e=[];for(let n=this.active.length-1;n>=0&&!(this.activeRank[n]<this.pointRank);n--)(this.activeTo[n]>t||this.activeTo[n]==t&&this.active[n].endSide>=this.point.endSide)&&e.push(this.active[n]);return e.reverse()}openEnd(t){let e=0;for(let n=this.activeTo.length-1;n>=0&&this.activeTo[n]>t;n--)e++;return e}}function at(t,e,n,r,i,o){t.goto(e),n.goto(r);let s=r+i,a=r,h=r-e;for(;;){let e=t.to+h-n.to||t.endSide-n.endSide,r=e<0?t.to+h:n.to,i=Math.min(r,s);if(t.point||n.point?t.point&&n.point&&(t.point==n.point||t.point.eq(n.point))&&ht(t.activeForPoint(t.to+h),n.activeForPoint(n.to))||o.comparePoint(a,i,t.point,n.point):i>a&&!ht(t.active,n.active)&&o.compareRange(a,i,t.active,n.active),r>s)break;a=r,e<=0&&t.next(),e>=0&&n.next()}}function ht(t,e){if(t.length!=e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!=e[n]&&!t[n].eq(e[n]))return!1;return!0}function ct(t,e){for(let n=e,r=t.length-1;n<r;n++)t[n]=t[n+1];t.pop()}function ut(t,e,n){for(let n=t.length-1;n>=e;n--)t[n+1]=t[n];t[e]=n}function lt(t,e){let n=-1,r=1e9;for(let i=0;i<e.length;i++)(e[i]-r||t[i].endSide-t[n].endSide)<0&&(n=i,r=e[i]);return n}var pt=function(){function t(t,{StateEffect:e}){this.cm=t,this.lastDocLines=this.cm.state.doc.text,this.lastCursorRange=this.cm.state.selection.main,this.callbacks={},this.otherCursors=[],this.addedStyleRules=[],this.ignoreChanges=!1,this.onBlur=this.onBlur.bind(this),this.onFocus=this.onFocus.bind(this),this.onCursorActivity=this.onCursorActivity.bind(this),cm.dispatch({effects:e.appendConfig.of(cm.constructor.updateListener.of((t=>{if(t.docChanged&&(!t.transactions[0]||!t.transactions[0].annotations.some((t=>"firepad"==t.type)))){let e=0,r=new n,i=new n;t.changes.toJSON().forEach((n=>{if("number"==typeof n)0!=n&&(e+=n,r=r.retain(n),i=i.retain(n));else if("object"==typeof n){const[o,...s]=n;if(o>0&&(r=r.delete(o),i=i.insert(t.startState.sliceDoc(e,e+o))),s){const t=s.join("\n");r=r.insert(t),i=i.delete(t.length)}}})),this.trigger("change",r,i)}this.lastDocLines=this.cm.state.doc.text})))})}return t.prototype.detach=function(){},t.prototype.getCursor=function(){var t=this.cm.state.selection.main;null==t&&(t=this.lastCursorRange);var e=t.from,n=t.to;if(e>n){var r=[n,e];e=r[0],n=r[1]}return new L(e,n)},t.prototype.setCursor=function(t){var e=t.position,n=t.selectionEnd;cm.dispatch({selection:{anchor:e,head:n}})},t.prototype.setOtherCursor=function(t,e,n){},t.prototype.registerCallbacks=function(t){this.callbacks=Object.assign({},this.callbacks,t)},t.prototype.registerUndo=function(t){if("function"!=typeof t)throw new Error("CodeMirror6Adapter: registerUndo method expects a callback function in parameter");this.callbacks.undo=t},t.prototype.registerRedo=function(t){if("function"!=typeof t)throw new Error("CodeMirror6Adapter: registerRedo method expects a callback function in parameter");this.callbacks.redo=t},t.prototype.trigger=function(t){if(this.callbacks.hasOwnProperty(t)){var e=this.callbacks[t];0;var n=[];if(arguments.length>1)for(var r=1;r<arguments.length;r++)n.push(arguments[r]);e.apply(null,n)}},t.prototype.onBlur=function(){this.monaco.getSelection().isEmpty()&&this.trigger("blur")},t.prototype.onFocus=function(){this.trigger("focus")},t.prototype.onCursorActivity=function(){var t=this;setTimeout((function(){return t.trigger("cursorActivity")}),1)},t.prototype.applyOperation=function(t){t.isNoop()||(this.ignoreChanges=!0);var e=t.ops,n=0;e.forEach((function(t){t.isRetain()?n+=t.chars:t.isInsert()?(cm.dispatch({annotations:[new K("firepad",!0)],changes:{from:n,to:n,insert:t.text}}),n+=t.text.length):t.isDelete()&&cm.dispatch({annotations:[new K("firepad",!0)],changes:{from:n,to:n+t.chars,insert:""}})})),this.lastDocLines=this.cm.state.doc.text,this.ignoreChanges=!1},t.prototype.invertOperation=function(t){t.invert(this.getValue())},t}();let dt;try{dt=Function("return this")()}catch(t){dt=window}const ft=function(){var e=dt.CodeMirror,p=dt.ace;function d(n,i,o){if(!(this instanceof d))return new d(n,i,o);if(!e&&!p&&!dt.monaco&&"CodeMirror6"!==i.type)throw new Error("Couldn't find CodeMirror, ACE or Monaco.  Did you forget to include codemirror.js/ace.js or import monaco?");if(this.zombie_=!1,"CodeMirror6"===i.type){this.codeMirror6_=this.editor_=i.editor;if(""!==this.codeMirror6_.state.doc.toString())throw new Error("Can't initialize Firepad with a CodeMirror6 instance that already contains text.")}else if(e&&i instanceof e){this.codeMirror_=this.editor_=i;var s=this.codeMirror_.getValue();if(""!==s)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else if(p&&i&&i.session instanceof p.EditSession){if(this.ace_=this.editor_=i,""!==(s=this.ace_.getValue()))throw new Error("Can't initialize Firepad with an ACE instance that already contains text.")}else if(dt.monaco&&i&&i instanceof dt.monaco.constructor){if(dt.monaco,this.monaco_=this.editor_=i,""!==(s=this.monaco_.getValue()))throw new Error("Can't initialize Firepad with a Monaco instance that already contains text.")}else this.codeMirror_=this.editor_=new e(i);var a;a=this.codeMirror6_?this.codeMirror6_.dom:this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_?this.ace_.container:this.monaco_.getDomNode(),this.firepadWrapper_=t.elt("div",null,{class:"firepad"}),a.parentNode.replaceChild(this.firepadWrapper_,a),this.firepadWrapper_.appendChild(a),this.editor_.firepad=this,this.options_=o||{},this.getOption("richTextShortcuts",!1)&&(e.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.addPoweredByLogo_(),this.codeMirror_&&this.codeMirror_.refresh();var h=this.getOption("userId",n.push().key),c=this.getOption("userColor",function(t){for(var e=1,n=0;n<t.length;n++)e=17*(e+t.charCodeAt(n))%360;return function(t,e,n){if(0===e)return f(n,n,n);var r=n<.5?n*(1+e):n+e-e*n,i=2*n-r,o=function(t){return t<0&&(t+=1),t>1&&(t-=1),6*t<1?i+6*(r-i)*t:2*t<1?r:3*t<2?i+6*(r-i)*(2/3-t):i};return f(o(t+1/3),o(t),o(t-1/3))}(e/360,1,.75)}(h));this.entityManager_=new x,this.firebaseAdapter_=new r(n,h,c),this.codeMirror6_?this.editorAdapter_=new pt(this.codeMirror6_,this.options_):this.codeMirror_?(this.richTextCodeMirror_=new B(this.codeMirror_,this.entityManager_,{cssPrefix:"firepad-"}),this.editorAdapter_=new D(this.richTextCodeMirror_)):this.ace_?this.editorAdapter_=new z(this.ace_):this.editorAdapter_=new V(this.monaco_),this.client_=new F(this.firebaseAdapter_,this.editorAdapter_);var u=this;this.firebaseAdapter_.on("cursor",(function(){u.trigger.apply(u,["cursor"].concat([].slice.call(arguments)))})),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",(function(){u.trigger.apply(u,["newLine"].concat([].slice.call(arguments)))})),this.firebaseAdapter_.on("ready",(function(){u.ready_=!0,u.ace_&&u.editorAdapter_.grabDocumentState(),u.monaco_&&u.editorAdapter_.grabDocumentState();var t=u.getOption("defaultText",null);t&&u.isHistoryEmpty()&&u.setText(t),u.trigger("ready")})),this.client_.on("synced",(function(t){u.trigger("synced",t)})),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important;}",t.appendChild(e),setTimeout((function(){t.removeChild(e)}),0)})}function f(t,e,n){function r(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+r(t)+r(e)+r(n)}return dt.monaco,t.makeEventEmitter(d),d.fromCodeMirror=d,d.fromACE=d,d.fromMonaco=d,d.fromCodeMirror6=(t,e,...n)=>d(t,{type:"CodeMirror6",editor:e},...n),d.prototype.dispose=function(){this.zombie_=!0,this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),this.firepadWrapper_.removeChild(editorWrapper),this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_),this.editor_.firepad=null,this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},d.prototype.setUserId=function(t){this.firebaseAdapter_.setUserId(t)},d.prototype.setUserColor=function(t){this.firebaseAdapter_.setColor(t)},d.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_?this.richTextCodeMirror_.getText():this.ace_?this.ace_.getSession().getDocument().getValue():this.monaco_.getModel().getValue()},d.prototype.setText=function(t){if(this.assertReady_("setText"),this.codeMirror6_)this.codeMirror6_.state.doc.toString();else{if(this.monaco_)return this.monaco_.getModel().setValue(t);if(this.ace_)return this.ace_.getSession().getDocument().setValue(t);this.codeMirror_.getWrapperElement().style.display="none",this.codeMirror_.setValue(""),this.insertText(0,t),this.codeMirror_.getWrapperElement().style.display="",this.codeMirror_.refresh()}this.editorAdapter_.setCursor({position:0,selectionEnd:0})},d.prototype.insertTextAtCursor=function(t){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},d.prototype.insertText=function(e,n){t.assert(!this.ace_,"Not supported for ace yet."),t.assert(!this.monaco_,"Not supported for monaco yet."),this.assertReady_("insertText"),"[object Array]"!==Object.prototype.toString.call(n)&&(n=[n]);var r=this;r.codeMirror_.operation((function(){for(var t=S(0===e,n),i=0;i<t.length;i++){var o=t[i].string,s=t[i].attributes;r.richTextCodeMirror_.insertText(e,o,s),e+=o.length}}))},d.prototype.getOperationForSpan=function(t,e){for(var r=this.richTextCodeMirror_.getRange(t,e),i=this.richTextCodeMirror_.getAttributeSpans(t,e),o=0,s=new n,a=0;a<i.length;a++)s.insert(r.substr(o,i[a].length),i[a].attributes),o+=i[a].length;return s},d.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},d.prototype.getHtmlFromSelection=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),n=this.codeMirror_.indexFromPos(t),r=this.codeMirror_.indexFromPos(e);return this.getHtmlFromRange(n,r)},d.prototype.getHtmlFromRange=function(t,e){this.assertReady_("getHtmlFromRange");var n=null!=t&&null!=e?this.getOperationForSpan(t,e):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return M(n,this.entityManager_)},d.prototype.insertHtml=function(t,e){var n=E(e,this.entityManager_);this.insertText(t,n)},d.prototype.insertHtmlAtCursor=function(t){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},d.prototype.setHtml=function(t){var e=E(t,this.entityManager_);this.setText(e)},d.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},d.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(i),this.codeMirror_.focus()},d.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(o),this.codeMirror_.focus()},d.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(s),this.codeMirror_.focus()},d.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(a),this.codeMirror_.focus()},d.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute(c,t),this.codeMirror_.focus()},d.prototype.font=function(t){this.richTextCodeMirror_.setAttribute(h,t),this.codeMirror_.focus()},d.prototype.color=function(t){this.richTextCodeMirror_.setAttribute(u,t),this.codeMirror_.focus()},d.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(l,"rgba(255,255,0,.65)"),this.codeMirror_.focus()},d.prototype.align=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(g,t),this.codeMirror_.focus()},d.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(m,"o"),this.codeMirror_.focus()},d.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(m,"u"),this.codeMirror_.focus()},d.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},d.prototype.newline=function(){this.richTextCodeMirror_.newline()},d.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},d.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},d.prototype.indent=function(){this.richTextCodeMirror_.indent(),this.codeMirror_.focus()},d.prototype.unindent=function(){this.richTextCodeMirror_.unindent(),this.codeMirror_.focus()},d.prototype.undo=function(){this.codeMirror_.undo()},d.prototype.redo=function(){this.codeMirror_.redo()},d.prototype.insertEntity=function(t,e,n){this.richTextCodeMirror_.insertEntityAtCursor(t,e,n)},d.prototype.insertEntityAt=function(t,e,n,r){this.richTextCodeMirror_.insertEntityAt(t,e,n,r)},d.prototype.registerEntity=function(t,e){this.entityManager_.register(t,e)},d.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},d.prototype.assertReady_=function(t){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+t+"]")},d.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},d.prototype.makeDialog_=function(e,n){var r=this,i=t.elt("input",null,{class:"firepad-dialog-input",id:e,type:"text",placeholder:n,autofocus:"autofocus"}),o=t.elt("a","Submit",{class:"firepad-btn",id:"submitbtn"});t.on(o,"click",t.stopEventAnd((function(){var t=document.getElementById("overlay");t.style.visibility="hidden";var n=document.getElementById(e).value;null!==n&&r.insertEntity(e,{src:n}),r.firepadWrapper_.removeChild(t)})));var s=t.elt("a","Cancel",{class:"firepad-btn"});t.on(s,"click",t.stopEventAnd((function(){var t=document.getElementById("overlay");t.style.visibility="hidden",r.firepadWrapper_.removeChild(t)})));var a=t.elt("div",[o,s],{class:"firepad-btn-group"}),h=t.elt("div",[i,a],{class:"firepad-dialog-div"}),c=t.elt("div",[h],{class:"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(c)},d.prototype.addToolbar_=function(){this.toolbar=new H(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",(function(){this.align("left")}),this),this.toolbar.on("center",(function(){this.align("center")}),this),this.toolbar.on("right",(function(){this.align("right")}),this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},d.prototype.addPoweredByLogo_=function(){var e=t.elt("a",null,{class:"powered-by-firepad"});e.setAttribute("href","http://www.firepad.io/"),e.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(e)},d.prototype.initializeKeyMap_=function(){function t(t){return function(e){setTimeout((function(){t.call(e.firepad)}),0)}}e.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),"Ctrl-H":t(this.highlight),"Cmd-H":t(this.highlight),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},d}();return Object.assign(ft,{Formatting:C,Text:k,Entity:v,LineFormatting:w,Line:A,TextOperation:n,Headless:O,RichTextCodeMirrorAdapter:D,ACEAdapter:z,MonacoAdapter:V}),ft}));
